{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <title>CodeSphere - –ò–Ω—Ç–µ—Ä–≤—å—é</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta charset="utf-8" />

    <style data-tag="reset-style-sheet">
      html { line-height: 1.15; overflow-y: auto;}body { margin: 0; overflow-y: auto;}* { box-sizing: border-box; border-width: 0; border-style: solid; -webkit-font-smoothing: antialiased;}p,li,ul,pre,div,h1,h2,h3,h4,h5,h6,figure,blockquote,figcaption { margin: 0; padding: 0;}button { background-color: transparent;}button,input,optgroup,select,textarea { font-family: inherit; font-size: 100%; line-height: 1.15; margin: 0;}button,select { text-transform: none;}button,[type="button"],[type="reset"],[type="submit"] { -webkit-appearance: button; color: inherit;}button::-moz-focus-inner,[type="button"]::-moz-focus-inner,[type="reset"]::-moz-focus-inner,[type="submit"]::-moz-focus-inner { border-style: none; padding: 0;}button:-moz-focus,[type="button"]:-moz-focus,[type="reset"]:-moz-focus,[type="submit"]:-moz-focus { outline: 1px dotted ButtonText;}a { color: inherit; text-decoration: inherit;}pre { white-space: normal;}input { padding: 2px 4px;}img { display: block;}details { display: block; margin: 0; padding: 0;}summary::-webkit-details-marker { display: none;}html { scroll-behavior: smooth }
    </style>
    <style data-tag="default-style-sheet">
      html {
        font-family: "Roboto Mono";
        font-size: 1rem;
      }
      body {
        font-weight: 400;
        font-style:normal;
        text-decoration: undefined;
        text-transform: undefined;
        letter-spacing: 0.01em;
        line-height: 1.6;
        color: var(--color-on-surface);
        background: var(--color-surface);
        fill: var(--color-on-surface);
      }
    </style>
    <link rel="stylesheet" href="https://unpkg.com/animate.css@4.1.1/animate.css" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Sans:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto+Mono:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;1,100;1,200;1,300;1,400;1,500;1,600;1,700&display=swap" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Rubik:ital,wght@0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" />
    <link rel="stylesheet" href="https://unpkg.com/@teleporthq/teleport-custom-scripts/dist/style.css" />

    <link rel="stylesheet" href="{% static 'style.css' %}" />
    <link href="{% static 'index.css' %}" rel="stylesheet" />
    <link href="{% static 'components/navigation.css' %}" rel="stylesheet" />
    <link href="{% static 'components/footer.css' %}" rel="stylesheet" />

    <style>
      /* –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∏–Ω—Ç–µ—Ä–≤—å—é */
      .interview-container {
        min-height: calc(100vh - 80px);
        display: flex;
        flex-direction: column;
        padding: 0;
        background: var(--color-surface, #ffffff);
        position: relative;
        overflow: visible;
      }

      /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —á–∞—Ç–∞ - –ø–æ–ª–Ω—ã–π —ç–∫—Ä–∞–Ω –¥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è */
      .interview-chat-container {
        width: 100%;
        max-width: 900px;
        margin: 0 auto;
        min-height: calc(100vh - 80px);
        display: flex;
        flex-direction: column;
        padding: 24px;
        transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        z-index: 10;
      }

      /* –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏–Ω—Ç–µ—Ä–≤—å—é */
      .interview-header {
        text-align: center;
        margin-bottom: 32px;
        padding-bottom: 24px;
        border-bottom: 2px solid rgba(0, 0, 0, 0.08);
      }

      .interview-title {
        font-size: 32px;
        font-weight: 600;
        color: var(--color-on-surface, #212529);
        margin-bottom: 8px;
      }

      .interview-subtitle {
        font-size: 16px;
        color: var(--color-on-surface-secondary, #6c757d);
      }

      /* –ü—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä */
      .interview-progress {
        margin-bottom: 24px;
        padding: 0 8px;
      }

      .progress-bar-container {
        width: 100%;
        height: 8px;
        background: rgba(0, 0, 0, 0.08);
        border-radius: 4px;
        overflow: hidden;
        position: relative;
      }

      .progress-bar {
        height: 100%;
        background: linear-gradient(90deg, var(--color-primary, #0066ff) 0%, var(--color-accent, #00a3b8) 100%);
        border-radius: 4px;
        transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
      }

      .progress-bar::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
        animation: shimmer 2s infinite;
      }

      @keyframes shimmer {
        0% { transform: translateX(-100%); }
        100% { transform: translateX(100%); }
      }

      .progress-text {
        text-align: center;
        margin-top: 8px;
        font-size: 14px;
        color: var(--color-on-surface-secondary, #6c757d);
      }

      /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —á–∞—Ç–∞ */
      .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 16px 0;
        margin-bottom: 16px;
        display: flex;
        flex-direction: column;
        gap: 16px;
        min-height: 0;
        max-height: none;
      }

      .chat-messages::-webkit-scrollbar {
        width: 8px;
      }

      .chat-messages::-webkit-scrollbar-track {
        background: #f8f9fa;
        border-radius: 10px;
      }

      .chat-messages::-webkit-scrollbar-thumb {
        background: #dee2e6;
        border-radius: 10px;
        transition: background 0.2s;
      }

      .chat-messages::-webkit-scrollbar-thumb:hover {
        background: #adb5bd;
      }

      /* –°–æ–æ–±—â–µ–Ω–∏—è —á–∞—Ç–∞ */
      .chat-message {
        display: flex;
        flex-direction: column;
        gap: 8px;
        animation: fadeInUp 0.4s ease-out;
      }

      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .message-question {
        background: linear-gradient(135deg, rgba(0, 102, 255, 0.1) 0%, rgba(0, 163, 184, 0.1) 100%);
        border-left: 4px solid var(--color-primary, #0066ff);
        padding: 16px 20px;
        border-radius: 12px;
        align-self: flex-start;
        max-width: 85%;
        box-shadow: 0 2px 8px rgba(0, 102, 255, 0.1);
      }

      .message-question-label {
        font-size: 12px;
        font-weight: 600;
        color: var(--color-primary, #0066ff);
        margin-bottom: 6px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .message-question-text {
        font-size: 15px;
        color: var(--color-on-surface, #212529);
        line-height: 1.6;
      }

      .message-answer {
        background: var(--color-surface, #ffffff);
        border: 2px solid rgba(0, 0, 0, 0.08);
        padding: 16px 20px;
        border-radius: 12px;
        align-self: flex-end;
        max-width: 85%;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      }

      .message-answer-label {
        font-size: 12px;
        font-weight: 600;
        color: var(--color-on-surface-secondary, #6c757d);
        margin-bottom: 6px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .message-answer-text {
        font-size: 15px;
        color: var(--color-on-surface, #212529);
        line-height: 1.6;
        white-space: pre-wrap;
      }

      .message-feedback {
        font-size: 13px;
        color: var(--color-on-surface-secondary, #6c757d);
        font-style: italic;
        margin-top: 4px;
        padding-left: 8px;
        border-left: 2px solid rgba(0, 0, 0, 0.1);
      }

      /* –ü–æ–ª–µ –≤–≤–æ–¥–∞ */
      .chat-input-container {
        padding: 16px;
        background: var(--color-surface, #ffffff);
        border-top: 1px solid rgba(0, 0, 0, 0.08);
        border-radius: 0 0 16px 16px;
      }

      .chat-input-wrapper {
        display: flex;
        gap: 12px;
        align-items: flex-end;
      }

      .chat-input {
        flex: 1;
        min-height: 60px;
        max-height: 200px;
        padding: 12px 16px;
        border: 2px solid rgba(0, 0, 0, 0.1);
        border-radius: 12px;
        font-size: 15px;
        font-family: inherit;
        resize: none;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        background: var(--color-surface, #ffffff);
        color: var(--color-on-surface, #212529);
      }

      .chat-input:focus {
        outline: none;
        border-color: var(--color-primary, #0066ff);
        box-shadow: 0 0 0 3px rgba(0, 102, 255, 0.1);
      }

      .chat-send-btn {
        padding: 12px 24px;
        background: linear-gradient(135deg, var(--color-primary, #0066ff) 0%, var(--color-accent, #00a3b8) 100%);
        color: var(--color-on-primary, #ffffff);
        border: none;
        border-radius: 12px;
        font-weight: 500;
        font-size: 15px;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        min-width: 100px;
        height: 60px;
      }

      .chat-send-btn:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 4px 16px rgba(0, 102, 255, 0.3);
      }

      .chat-send-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      /* –≠–∫—Ä–∞–Ω –æ–ø–∏—Å–∞–Ω–∏—è –Ω–∞–≤—ã–∫–æ–≤ */
      .hard-desc-screen {
        display: flex;
        flex-direction: column;
        gap: 24px;
        padding: 32px;
        background: var(--color-surface, #ffffff);
        border-radius: 16px;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
      }

      .hard-desc-title {
        font-size: 24px;
        font-weight: 600;
        color: var(--color-on-surface, #212529);
        text-align: center;
      }

      .hard-desc-textarea {
        width: 100%;
        min-height: 200px;
        padding: 16px;
        border: 2px solid rgba(0, 0, 0, 0.1);
        border-radius: 12px;
        font-size: 15px;
        font-family: inherit;
        resize: vertical;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        background: var(--color-surface, #ffffff);
        color: var(--color-on-surface, #212529);
      }

      .hard-desc-textarea:focus {
        outline: none;
        border-color: var(--color-primary, #0066ff);
        box-shadow: 0 0 0 3px rgba(0, 102, 255, 0.1);
      }

      .hard-desc-hint {
        font-size: 14px;
        color: var(--color-on-surface-secondary, #6c757d);
        text-align: center;
      }

      /* –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è - –ø–ª–∞—à–∫–∞ —Å–ø—Ä–∞–≤–∞ */
      .interview-chat-container.completed {
        width: 380px;
        max-width: 380px;
        height: auto;
        max-height: calc(100vh - 120px);
        position: fixed;
        right: 24px;
        top: 100px;
        bottom: auto;
        padding: 20px;
        background: var(--color-surface, #ffffff);
        border-radius: 16px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
        z-index: 1000;
        transform: translateX(0);
        transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        overflow-y: auto;
      }


      .interview-chat-container.completed .interview-header {
        display: none;
      }

      .interview-chat-container.completed .chat-messages {
        max-height: 400px;
        margin-bottom: 12px;
      }

      .interview-chat-container.completed .chat-input-container {
        display: none;
      }

      .interview-chat-container.completed .progress-bar-container {
        display: none;
      }

      .chat-minimized-header {
        display: none;
        padding: 12px 16px;
        background: linear-gradient(135deg, var(--color-primary, #0066ff) 0%, var(--color-accent, #00a3b8) 100%);
        color: white;
        border-radius: 12px 12px 0 0;
        font-weight: 600;
        font-size: 14px;
        margin: -20px -20px 16px -20px;
        cursor: pointer;
      }

      .interview-chat-container.completed .chat-minimized-header {
        display: block;
      }

      /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
      @media (max-width: 1200px) {
        .interview-chat-container.completed {
          width: 320px;
          right: 16px;
          top: 90px;
        }
      }

      @media (max-width: 768px) {
        .interview-chat-container {
          padding: 16px;
          min-height: calc(100vh - 70px);
        }

        .interview-title {
          font-size: 24px;
        }

        .interview-subtitle {
          font-size: 14px;
        }

        .message-question,
        .message-answer {
          max-width: 90%;
        }

        .interview-chat-container.completed {
          width: calc(100% - 32px);
          right: 16px;
          left: 16px;
          top: 80px;
          max-height: calc(100vh - 100px);
        }


        .chat-input-wrapper {
          flex-direction: column;
        }

        .chat-send-btn {
          width: 100%;
          height: 48px;
        }
      }

      @media (max-width: 480px) {
        .interview-chat-container {
          padding: 12px;
        }

        .interview-title {
          font-size: 20px;
        }

        .hard-desc-screen {
          padding: 20px;
        }

        .message-question,
        .message-answer {
          max-width: 95%;
          padding: 12px 16px;
        }
      }

      /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ */
      .loading-indicator {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        color: var(--color-on-surface-secondary, #6c757d);
        font-size: 14px;
      }

      .loading-dots {
        display: inline-flex;
        gap: 4px;
      }

      .loading-dot {
        width: 6px;
        height: 6px;
        background: var(--color-primary, #0066ff);
        border-radius: 50%;
        animation: bounce 1.4s infinite ease-in-out both;
      }

      .loading-dot:nth-child(1) { animation-delay: -0.32s; }
      .loading-dot:nth-child(2) { animation-delay: -0.16s; }

      @keyframes bounce {
        0%, 80%, 100% { transform: scale(0); }
        40% { transform: scale(1); }
      }

      /* –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ */
      .error-message {
        background: rgba(220, 53, 69, 0.1);
        color: #dc3545;
        padding: 12px 16px;
        border-radius: 8px;
        border-left: 4px solid #dc3545;
        margin-bottom: 16px;
        font-size: 14px;
      }

      /* –£—Å–ø–µ—à–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ */
      .completion-message {
        background: linear-gradient(135deg, rgba(40, 167, 69, 0.1) 0%, rgba(40, 167, 69, 0.05) 100%);
        border: 2px solid rgba(40, 167, 69, 0.3);
        padding: 24px;
        border-radius: 12px;
        text-align: center;
        margin-bottom: 16px;
      }

      .completion-icon {
        font-size: 48px;
        margin-bottom: 12px;
      }

      .completion-text {
        font-size: 18px;
        font-weight: 600;
        color: #28a745;
        margin-bottom: 8px;
      }

      .completion-subtext {
        font-size: 14px;
        color: var(--color-on-surface-secondary, #6c757d);
      }
    </style>
</head>
<body>
    <div class="home-container1">
        <!-- Navigation -->
        <navigation-wrapper class="navigation-wrapper">
            <div class="navigation-container1">
                <nav id="mainNavigation" class="navigation">
                    <div class="navigation-container">
                        <div class="navigation-left">
                            <a href="{% url 'home' %}">
                                <div class="navigation-link"><span>–ì–ª–∞–≤–Ω–∞—è</span></div>
                            </a>
                            {% if user.is_authenticated and user.is_candidate %}
                                {% if show_interview_link %}
                                <a href="{% url 'interview' %}">
                                    <div class="navigation-link"><span>–ò–Ω—Ç–µ—Ä–≤—å—é</span></div>
                                </a>
                                {% endif %}
                                {% if show_editor_link %}
                                <a href="{% url 'runcode' %}">
                                    <div class="navigation-link"><span>–†–µ–¥–∞–∫—Ç–æ—Ä</span></div>
                                </a>
                                {% endif %}
                            {% else %}
                                <a href="{% url 'runcode' %}">
                                    <div class="navigation-link"><span>–†–µ–¥–∞–∫—Ç–æ—Ä</span></div>
                                </a>
                            {% endif %}
                        </div>
                        <a href="{% url 'home' %}">
                            <div class="navigation-logo">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" class="navigation-logo-icon">
                                    <path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m16 18l6-6l-6-6M8 6l-6 6l6 6"></path>
                                </svg>
                                <span class="navigation-logo-text">CodeSphere</span>
                            </div>
                        </a>
                        <div class="navigation-right">
                            {% if user.is_authenticated %}
                                <span class="navigation-link" style="color: var(--color-on-surface-secondary, #6c757d); margin-right: 12px;">
                                    {{ user.username }} ({{ user.get_role_display }})
                                </span>
                                <a href="{% url 'logout' %}">
                                    <div class="navigation-link"><span>–í—ã–π—Ç–∏</span></div>
                                </a>
                            {% else %}
                                <a href="{% url 'login' %}">
                                    <div class="navigation-link"><span>–í—Ö–æ–¥</span></div>
                                </a>
                                <a href="{% url 'register' %}">
                                    <div class="navigation-cta btn btn-primary">
                                        <span>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</span>
                                    </div>
                                </a>
                            {% endif %}
                        </div>
                        <button id="navToggle" aria-expanded="false" aria-label="–û—Ç–∫—Ä—ã—Ç—å –º–µ–Ω—é –Ω–∞–≤–∏–≥–∞—Ü–∏–∏" class="navigation-toggle">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
                                <path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5h16M4 12h16M4 19h16"></path>
                            </svg>
                        </button>
                    </div>
                </nav>
            </div>
        </navigation-wrapper>

        <!-- Interview Container -->
        <div class="interview-container">
            <div class="interview-chat-container" id="chatContainer">
                <div class="chat-minimized-header" id="minimizedHeader">
                    üí¨ –ò—Å—Ç–æ—Ä–∏—è –∏–Ω—Ç–µ—Ä–≤—å—é
                </div>

                <div class="interview-header" id="interview-header">
                    <h1 class="interview-title">–¢–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–æ–µ –∏–Ω—Ç–µ—Ä–≤—å—é</h1>
                    <p class="interview-subtitle">–û—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –æ –≤–∞—à–∏—Ö –∑–Ω–∞–Ω–∏—è—Ö –∞–ª–≥–æ—Ä–∏—Ç–º–æ–≤ –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä –¥–∞–Ω–Ω—ã—Ö</p>
                </div>

                <div class="interview-progress" id="progressContainer">
                    <div class="progress-bar-container">
                        <div class="progress-bar" id="progressBar" style="width: 0%"></div>
                    </div>
                    <div class="progress-text" id="progressText">–ù–∞—á–∞–ª–æ –∏–Ω—Ç–µ—Ä–≤—å—é</div>
                </div>

                <div class="chat-messages" id="chatMessages">
                    <!-- –°–æ–æ–±—â–µ–Ω–∏—è –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </div>

                <!-- –≠–∫—Ä–∞–Ω –æ–ø–∏—Å–∞–Ω–∏—è –Ω–∞–≤—ã–∫–æ–≤ -->
                <div class="hard-desc-screen" id="hardDescScreen">
                    <h2 class="hard-desc-title">–û–ø–∏—à–∏—Ç–µ –≤–∞—à–∏ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –Ω–∞–≤—ã–∫–∏</h2>
                    <textarea 
                        id="hardDescInput" 
                        class="hard-desc-textarea" 
                        placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –∑–Ω–∞—é Python, Django, PostgreSQL, –æ–ø—ã—Ç —Ä–∞–±–æ—Ç—ã —Å REST API, Docker, –∞–ª–≥–æ—Ä–∏—Ç–º—ã –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö..."
                    ></textarea>
                    <p class="hard-desc-hint">–û–ø–∏—à–∏—Ç–µ –≤–∞—à–∏ –Ω–∞–≤—ã–∫–∏ –ø–æ–¥—Ä–æ–±–Ω–æ - —ç—Ç–æ –ø–æ–º–æ–∂–µ—Ç —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å—ã –¥–ª—è –∏–Ω—Ç–µ—Ä–≤—å—é</p>
                    <button class="chat-send-btn" id="startHardDescBtn">–ù–∞—á–∞—Ç—å –∏–Ω—Ç–µ—Ä–≤—å—é</button>
                </div>

                <!-- –ü–æ–ª–µ –≤–≤–æ–¥–∞ –¥–ª—è –æ—Ç–≤–µ—Ç–æ–≤ -->
                <div class="chat-input-container" id="chatInputContainer" style="display: none;">
                    <div class="chat-input-wrapper">
                        <textarea 
                            id="chatInput" 
                            class="chat-input" 
                            placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –æ—Ç–≤–µ—Ç..."
                            rows="3"
                        ></textarea>
                        <button class="chat-send-btn" id="sendBtn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                    </div>
                </div>

                <!-- –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ -->
                <div class="error-message" id="errorMessage" style="display: none;"></div>
            </div>
        </div>
    </div>

    <script>
      // –°–æ—Å—Ç–æ—è–Ω–∏–µ –∏–Ω—Ç–µ—Ä–≤—å—é
      let interviewState = {
        stage: 'init', // init, hard_desc, theory, finished
        currentQuestion: null,
        chatHistory: [],
        isLoading: false
      };

      const chatContainer = document.getElementById('chatContainer');
      const chatMessages = document.getElementById('chatMessages');
      const chatInput = document.getElementById('chatInput');
      const sendBtn = document.getElementById('sendBtn');
      const hardDescScreen = document.getElementById('hardDescScreen');
      const chatInputContainer = document.getElementById('chatInputContainer');
      const startHardDescBtn = document.getElementById('startHardDescBtn');
      const hardDescInput = document.getElementById('hardDescInput');
      const progressBar = document.getElementById('progressBar');
      const progressText = document.getElementById('progressText');
      const errorMessage = document.getElementById('errorMessage');
      const minimizedHeader = document.getElementById('minimizedHeader');

      // –ü–æ–ª—É—á–∏—Ç—å CSRF —Ç–æ–∫–µ–Ω
      function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
          const cookies = document.cookie.split(';');
          for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
              cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
              break;
            }
          }
        }
        return cookieValue;
      }

      // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ AJAX –∑–∞–ø—Ä–æ—Å–æ–≤
      async function interviewAPI(action, data = {}) {
        const formData = new FormData();
        formData.append('action', action);
        const csrftoken = getCookie('csrftoken');
        if (csrftoken) {
          formData.append('csrfmiddlewaretoken', csrftoken);
        } else {
          console.warn('CSRF token not found!');
        }
        
        for (const [key, value] of Object.entries(data)) {
          formData.append(key, value);
        }

        try {
          const response = await fetch('{% url "interview_api" %}', {
            method: 'POST',
            body: formData,
            headers: {
              'X-CSRFToken': csrftoken || ''
            }
          });

          if (!response.ok) {
            // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å JSON —Å –æ—à–∏–±–∫–æ–π
            let errorData;
            try {
              errorData = await response.json();
            } catch (e) {
              errorData = { error: `HTTP error! status: ${response.status}` };
            }
            console.error('API Response Error:', errorData);
            return errorData;
          }

          const result = await response.json();
          console.log('API Response:', result);
          return result;
        } catch (error) {
          console.error('API Error:', error);
          return {
            success: false,
            error: `–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º: ${error.message}`,
            message: '–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.'
          };
        }
      }

      // –ü–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É
      function showError(message) {
        if (!errorMessage) {
          console.error('Error message element not found!');
          alert(message); // Fallback –Ω–∞ alert
          return;
        }
        errorMessage.textContent = message;
        errorMessage.style.display = 'block';
        // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ –æ—à–∏–±–∫–µ
        errorMessage.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        setTimeout(() => {
          if (errorMessage) {
            errorMessage.style.display = 'none';
          }
        }, 8000); // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –≤—Ä–µ–º—è –ø–æ–∫–∞–∑–∞ –¥–æ 8 —Å–µ–∫—É–Ω–¥
      }

      // –î–æ–±–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç
      function addMessage(type, text, feedback = null) {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'chat-message';

        if (type === 'question') {
          messageDiv.innerHTML = `
            <div class="message-question">
              <div class="message-question-label">üí¨ –í–æ–ø—Ä–æ—Å</div>
              <div class="message-question-text">${escapeHtml(text)}</div>
            </div>
          `;
        } else if (type === 'answer') {
          let feedbackHtml = '';
          if (feedback) {
            feedbackHtml = `<div class="message-feedback">${escapeHtml(feedback)}</div>`;
          }
          messageDiv.innerHTML = `
            <div class="message-answer">
              <div class="message-answer-label">‚úçÔ∏è –í–∞—à –æ—Ç–≤–µ—Ç</div>
              <div class="message-answer-text">${escapeHtml(text)}</div>
              ${feedbackHtml}
            </div>
          `;
        }

        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      // –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ HTML
      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      // –û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å
      function updateProgress(current, total) {
        const percentage = total > 0 ? (current / total) * 100 : 0;
        progressBar.style.width = `${percentage}%`;
        
        if (total > 0) {
          progressText.textContent = `–í–æ–ø—Ä–æ—Å ${current} –∏–∑ ${total}`;
        } else {
          progressText.textContent = '–ù–∞—á–∞–ª–æ –∏–Ω—Ç–µ—Ä–≤—å—é';
        }
      }

      // –ù–∞—á–∞—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ –Ω–∞–≤—ã–∫–æ–≤
      async function startHardDesc() {
        const hardDesc = hardDescInput.value.trim();
        
        if (!hardDesc || hardDesc.length < 10) {
          showError('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–ø–∏—à–∏—Ç–µ –≤–∞—à–∏ –Ω–∞–≤—ã–∫–∏ –±–æ–ª–µ–µ –ø–æ–¥—Ä–æ–±–Ω–æ (–º–∏–Ω–∏–º—É–º 10 —Å–∏–º–≤–æ–ª–æ–≤)');
          return;
        }

        setLoading(true);
        try {
          const result = await interviewAPI('start_hard_desc', { hard_desc: hardDesc });

          if (!result) {
            showError('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.');
            setLoading(false);
            return;
          }

          // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–∞–Ω–µ–Ω
          if (result.banned) {
            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É, —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –±–∞–Ω–∞
            window.location.reload();
            return;
          }

          if (result.success) {
            // –°–∫—Ä—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω –æ–ø–∏—Å–∞–Ω–∏—è –Ω–∞–≤—ã–∫–æ–≤
            hardDescScreen.style.display = 'none';
            chatInputContainer.style.display = 'block';
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º –∏–Ω—Ç–µ—Ä–≤—å—é
            await startInterview();
          } else {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É
            const errorMsg = result.error || result.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –æ–ø–∏—Å–∞–Ω–∏—è –Ω–∞–≤—ã–∫–æ–≤';
            showError(errorMsg);
            console.error('API Error:', result);
          }
        } catch (error) {
          console.error('Error in startHardDesc:', error);
          showError('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –¥–∞–Ω–Ω—ã—Ö. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
        } finally {
          setLoading(false);
        }
      }

      // –ó–∞–ø—É—Å—Ç–∏—Ç—å –∏–Ω—Ç–µ—Ä–≤—å—é
      async function startInterview() {
        setLoading(true);
        try {
          const result = await interviewAPI('start_interview');

          if (!result) {
            showError('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.');
            setLoading(false);
            return;
          }

          if (result.success) {
            interviewState.stage = 'theory';
            await getNextQuestion();
          } else {
            const errorMsg = result.error || result.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –∏–Ω—Ç–µ—Ä–≤—å—é';
            showError(errorMsg);
            console.error('API Error:', result);
          }
        } catch (error) {
          console.error('Error in startInterview:', error);
          showError('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –∏–Ω—Ç–µ—Ä–≤—å—é. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
        } finally {
          setLoading(false);
        }
      }

      // –ü–æ–ª—É—á–∏—Ç—å —Å–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å
      async function getNextQuestion() {
        setLoading(true);
        const result = await interviewAPI('get_question');

        if (result) {
          if (result.finished) {
            // –ò–Ω—Ç–µ—Ä–≤—å—é –∑–∞–≤–µ—Ä—à–µ–Ω–æ
            completeInterview();
          } else if (result.question) {
            interviewState.currentQuestion = result.question;
            
            // –ï—Å–ª–∏ —ç—Ç–æ –Ω–∞–≤–æ–¥—è—â–∏–π –≤–æ–ø—Ä–æ—Å, –¥–æ–±–∞–≤–ª—è–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—É—é –º–µ—Ç–∫—É
            const questionText = result.is_hint ? 
              `üí° –ù–∞–≤–æ–¥—è—â–∏–π –≤–æ–ø—Ä–æ—Å:\n${result.question}` : 
              result.question;
            
            addMessage('question', questionText);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
            const totalQuestions = result.total_questions || 3;
            const currentProgress = result.current_idx || 1;
            updateProgress(currentProgress, totalQuestions);
          }
        }

        setLoading(false);
      }

      // –û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç
      async function submitAnswer() {
        const answer = chatInput.value.trim();
        
        if (!answer || answer.length < 3) {
          showError('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –¥–∞–π—Ç–µ –±–æ–ª–µ–µ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—ã–π –æ—Ç–≤–µ—Ç (–º–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞)');
          return;
        }

        setLoading(true);
        const result = await interviewAPI('submit_answer', { answer: answer });

        if (result && result.success) {
          // –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –≤ —á–∞—Ç
          const feedback = result.last_qa?.comment || null;
          addMessage('answer', answer, feedback);
          
          // –î–æ–±–∞–≤–ª—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é
          if (result.last_qa) {
            interviewState.chatHistory.push(result.last_qa);
          }
          
          // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
          chatInput.value = '';

          // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–≤–µ—Ä—à–µ–Ω–∞ –ª–∏ —Ç–µ–æ—Ä–∏—è
          if (result.theory_completed) {
            completeInterview();
          } else {
            // –ü–æ–ª—É—á–∞–µ–º —Å–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å (–º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–∞–≤–æ–¥—è—â–∏–π –∏–ª–∏ —Å–ª–µ–¥—É—é—â–∏–π –æ—Å–Ω–æ–≤–Ω–æ–π)
            setTimeout(() => {
              getNextQuestion();
            }, 1000);
          }
        } else if (result) {
          showError(result.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –æ—Ç–≤–µ—Ç–∞');
        }

        setLoading(false);
      }

      // –ó–∞–≤–µ—Ä—à–∏—Ç—å –∏–Ω—Ç–µ—Ä–≤—å—é
      function completeInterview() {
        // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏
        const completionDiv = document.createElement('div');
        completionDiv.className = 'completion-message';
        completionDiv.innerHTML = `
          <div class="completion-icon">‚úÖ</div>
          <div class="completion-text">–¢–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∞—è —á–∞—Å—Ç—å –∑–∞–≤–µ—Ä—à–µ–Ω–∞!</div>
          <div class="completion-subtext">–ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –≤–∞—Å –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π —ç—Ç–∞–ø...</div>
        `;
        chatMessages.appendChild(completionDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;

        // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
        progressBar.style.width = '100%';
        progressText.textContent = '–ò–Ω—Ç–µ—Ä–≤—å—é –∑–∞–≤–µ—Ä—à–µ–Ω–æ';

        // –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
        const link = document.createElement('link');
        link.rel = 'prefetch';
        link.href = '{% url "runcode" %}?interview_completed=1';
        document.head.appendChild(link);

        // –°–∫—Ä—ã–≤–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
        const inputContainer = document.getElementById('chatInputContainer');
        if (inputContainer) inputContainer.style.display = 'none';

        // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
        setTimeout(() => {
          window.location.href = '{% url "runcode" %}?interview_completed=1';
        }, 3000);
      }


      // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏
      function setLoading(loading) {
        interviewState.isLoading = loading;
        sendBtn.disabled = loading;
        startHardDescBtn.disabled = loading;
        
        if (loading) {
          sendBtn.innerHTML = '<span class="loading-indicator"><span class="loading-dots"><span class="loading-dot"></span><span class="loading-dot"></span><span class="loading-dot"></span></span> –û—Ç–ø—Ä–∞–≤–∫–∞...</span>';
          startHardDescBtn.innerHTML = '<span class="loading-indicator"><span class="loading-dots"><span class="loading-dot"></span><span class="loading-dot"></span><span class="loading-dot"></span></span> –ó–∞–≥—Ä—É–∑–∫–∞...</span>';
        } else {
          sendBtn.innerHTML = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å';
          startHardDescBtn.innerHTML = '–ù–∞—á–∞—Ç—å –∏–Ω—Ç–µ—Ä–≤—å—é';
        }
      }

      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
      if (startHardDescBtn) {
        startHardDescBtn.addEventListener('click', function(e) {
          e.preventDefault();
          console.log('Start button clicked');
          startHardDesc();
        });
      } else {
        console.error('Start button not found!');
      }

      if (sendBtn) {
        sendBtn.addEventListener('click', submitAnswer);
      } else {
        console.error('Send button not found!');
      }

      chatInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          if (!interviewState.isLoading) {
            submitAnswer();
          }
        }
      });

      // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ textarea
      chatInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 200) + 'px';
      });

      hardDescInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 300) + 'px';
      });

      // –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞
      async function loadChatHistory() {
        const result = await interviewAPI('get_history');
        if (result && result.chat_history) {
          interviewState.chatHistory = result.chat_history;
          
          // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏
          result.chat_history.forEach((item) => {
            if (item.type === 'theory_qa') {
              addMessage('question', item.question);
              addMessage('answer', item.answer, item.comment || null);
            }
          });
          
          // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
          const answeredQuestions = result.chat_history.filter(m => m.type === 'theory_qa' && !m.after_hint).length;
          updateProgress(answeredQuestions, 3);
          
          // –ï—Å–ª–∏ –µ—Å—Ç—å —Ç–µ–∫—É—â–∏–π –≤–æ–ø—Ä–æ—Å, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –µ–≥–æ
          if (result.stage === 'theory') {
            await getNextQuestion();
          }
        }
      }

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
      document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM loaded, initializing interview page...');
        console.log('Elements:', {
          startHardDescBtn: !!startHardDescBtn,
          hardDescInput: !!hardDescInput,
          errorMessage: !!errorMessage,
          chatInputContainer: !!chatInputContainer
        });

        // –ï—Å–ª–∏ –∏–Ω—Ç–µ—Ä–≤—å—é —É–∂–µ –Ω–∞—á–∞—Ç–æ, –∑–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é
        {% if interview_started %}
          console.log('Interview already started, loading history...');
          if (hardDescScreen) hardDescScreen.style.display = 'none';
          if (chatInputContainer) chatInputContainer.style.display = 'block';
          loadChatHistory();
        {% else %}
          console.log('Interview not started yet');
        {% endif %}
      });
    </script>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –±–∞–Ω–∞ -->
    {% include 'codeapp/ban_modal.html' %}
</body>
</html>

