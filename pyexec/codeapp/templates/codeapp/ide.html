{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <title>CodeSphere - Редактор кода</title>
    <meta property="og:title" content="CodeSphere - Редактор кода" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta charset="utf-8" />

    <style data-tag="reset-style-sheet">
      html { line-height: 1.15;}body { margin: 0;}* { box-sizing: border-box; border-width: 0; border-style: solid; -webkit-font-smoothing: antialiased;}p,li,ul,pre,div,h1,h2,h3,h4,h5,h6,figure,blockquote,figcaption { margin: 0; padding: 0;}button { background-color: transparent;}button,input,optgroup,select,textarea { font-family: inherit; font-size: 100%; line-height: 1.15; margin: 0;}button,select { text-transform: none;}button,[type="button"],[type="reset"],[type="submit"] { -webkit-appearance: button; color: inherit;}button::-moz-focus-inner,[type="button"]::-moz-focus-inner,[type="reset"]::-moz-focus-inner,[type="submit"]::-moz-focus-inner { border-style: none; padding: 0;}button:-moz-focus,[type="button"]:-moz-focus,[type="reset"]:-moz-focus,[type="submit"]:-moz-focus { outline: 1px dotted ButtonText;}a { color: inherit; text-decoration: inherit;}pre { white-space: normal;}input { padding: 2px 4px;}img { display: block;}details { display: block; margin: 0; padding: 0;}summary::-webkit-details-marker { display: none;}[data-thq="accordion"] [data-thq="accordion-content"] { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-in-out; padding: 0;}[data-thq="accordion"] details[data-thq="accordion-trigger"][open] + [data-thq="accordion-content"] { max-height: 1000vh;}details[data-thq="accordion-trigger"][open] summary [data-thq="accordion-icon"] { transform: rotate(180deg);}html { scroll-behavior: smooth }
    </style>
    <style data-tag="default-style-sheet">
      html {
        font-family: "Roboto Mono";
        font-size: 1rem;
      }

      body {
        font-weight: 400;
        font-style:normal;
        text-decoration: undefined;
        text-transform: undefined;
        letter-spacing: 0.01em;
        line-height: 1.6;
        color: var(--color-on-surface);
        background: var(--color-surface);
        fill: var(--color-on-surface);
      }
    </style>
    <link rel="stylesheet" href="https://unpkg.com/animate.css@4.1.1/animate.css" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Sans:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=STIX+Two+Text:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500;1,600;1,700&display=swap" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto+Mono:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;1,100;1,200;1,300;1,400;1,500;1,600;1,700&display=swap" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Rubik:ital,wght@0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" />
    <link rel="stylesheet" href="https://unpkg.com/@teleporthq/teleport-custom-scripts/dist/style.css" />

    <!-- CodeMirror -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/eclipse.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/hint/show-hint.min.css">

    <link rel="stylesheet" href="{% static 'style.css' %}" />
    <link href="{% static 'index.css' %}" rel="stylesheet" />
    <link href="{% static 'components/navigation.css' %}" rel="stylesheet" />
    <link href="{% static 'components/footer.css' %}" rel="stylesheet" />

    <style>
      .editor-section {
        height: calc(100vh - 80px);
        padding: 0;
        background: var(--color-surface, #ffffff);
        overflow: hidden;
      }

      .editor-container {
        height: 100%;
        margin: 0;
        display: flex;
        flex-direction: column;
      }

      .editor-layout {
        display: grid;
        grid-template-columns: 40% 12px calc(60% - 12px);
        gap: 0;
        height: calc(100vh - 104px);
        margin: 0;
        padding: 0;
        position: relative;
      }

      /* Плашка интервью справа */
      .interview-sidebar {
        position: fixed;
        right: 16px;
        bottom: 16px;
        width: 380px;
        max-width: 380px;
        background: var(--color-surface, #ffffff);
        border-radius: 16px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
        z-index: 1000;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        opacity: 0;
        transform: translateY(20px) scale(0.95);
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        /* По умолчанию свернута - компактный вид */
        max-height: 50px;
        height: auto;
      }

      .interview-sidebar.visible {
        opacity: 1;
        transform: translateY(0) scale(1);
      }

      /* Когда развернута */
      .interview-sidebar:not(.collapsed) {
        max-height: calc(100vh - 120px);
        height: auto;
      }

      .interview-sidebar-header {
        padding: 16px 20px;
        background: linear-gradient(135deg, var(--color-primary, #0066ff) 0%, var(--color-accent, #00a3b8) 100%);
        color: white;
        font-weight: 600;
        font-size: 14px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        cursor: pointer;
        user-select: none;
      }

      .interview-sidebar-header:hover {
        background: linear-gradient(135deg, var(--color-accent, #00a3b8) 0%, var(--color-primary, #0066ff) 100%);
      }

      .interview-sidebar-toggle {
        background: none;
        border: none;
        color: white;
        cursor: pointer;
        padding: 4px 8px;
        font-size: 18px;
        line-height: 1;
        transition: transform 0.3s;
      }

      .interview-sidebar.collapsed .interview-sidebar-toggle {
        transform: rotate(180deg);
      }

      .interview-sidebar-content {
        flex: 1;
        overflow-y: auto;
        padding: 16px;
        display: flex;
        flex-direction: column;
        gap: 12px;
        max-height: calc(100vh - 180px);
      }

      .interview-sidebar-content::-webkit-scrollbar {
        width: 6px;
      }

      .interview-sidebar-content::-webkit-scrollbar-track {
        background: #f8f9fa;
        border-radius: 10px;
      }

      .interview-sidebar-content::-webkit-scrollbar-thumb {
        background: #dee2e6;
        border-radius: 10px;
      }

      .interview-sidebar-content::-webkit-scrollbar-thumb:hover {
        background: #adb5bd;
      }

      .interview-sidebar.collapsed .interview-sidebar-content {
        display: none;
      }

      /* Компактный вид в свернутом состоянии */
      .interview-sidebar.collapsed {
        max-height: 50px !important;
        height: 50px;
        width: auto;
        min-width: 200px;
      }

      .interview-sidebar.collapsed .interview-sidebar-header {
        padding: 12px 16px;
      }

      .interview-message {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .interview-message-question {
        background: linear-gradient(135deg, rgba(0, 102, 255, 0.1) 0%, rgba(0, 163, 184, 0.1) 100%);
        border-left: 3px solid var(--color-primary, #0066ff);
        padding: 12px 16px;
        border-radius: 8px;
        font-size: 13px;
        line-height: 1.5;
        white-space: pre-wrap;
        word-wrap: break-word;
      }

      .interview-message-answer {
        background: var(--color-surface, #ffffff);
        border: 1px solid rgba(0, 0, 0, 0.08);
        padding: 12px 16px;
        border-radius: 8px;
        font-size: 13px;
        line-height: 1.5;
        margin-left: auto;
        max-width: 85%;
        white-space: pre-wrap;
        word-wrap: break-word;
      }

      .interview-message-label {
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 4px;
      }

      .interview-message-question .interview-message-label {
        color: var(--color-primary, #0066ff);
      }

      .interview-message-answer .interview-message-label {
        color: var(--color-on-surface-secondary, #6c757d);
      }

      /* Поле ввода чата */
      .chat-input-container {
        display: flex;
        gap: 8px;
        padding: 12px 16px;
        border-top: 1px solid rgba(0, 0, 0, 0.08);
        background: #f8f9fa;
      }

      .interview-sidebar.collapsed .chat-input-container {
        display: none;
      }

      .chat-input {
        flex: 1;
        padding: 10px 14px;
        border: 1px solid rgba(0, 0, 0, 0.1);
        border-radius: 20px;
        font-size: 13px;
        outline: none;
        transition: border-color 0.2s;
      }

      .chat-input:focus {
        border-color: var(--color-primary, #0066ff);
      }

      .chat-send-btn {
        width: 40px;
        height: 40px;
        border: none;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--color-primary, #0066ff) 0%, var(--color-accent, #00a3b8) 100%);
        color: white;
        font-size: 16px;
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
      }

      .chat-send-btn:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 12px rgba(0, 102, 255, 0.3);
      }

      .chat-send-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      /* Индикатор загрузки */
      .chat-loading {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 12px 16px;
        color: #6c757d;
        font-size: 13px;
      }

      .chat-loading::before {
        content: '';
        width: 16px;
        height: 16px;
        border: 2px solid #dee2e6;
        border-top-color: var(--color-primary, #0066ff);
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        to { transform: rotate(360deg); }
      }

      /* Сообщение об обратной связи */
      .feedback-message {
        background: linear-gradient(135deg, rgba(40, 167, 69, 0.1) 0%, rgba(0, 163, 184, 0.1) 100%);
        border-left: 3px solid #28a745;
        padding: 12px 16px;
        border-radius: 8px;
        margin-bottom: 12px;
      }

      .feedback-message.warning {
        background: linear-gradient(135deg, rgba(255, 193, 7, 0.1) 0%, rgba(255, 152, 0, 0.1) 100%);
        border-left-color: #ffc107;
      }

      .feedback-message.error {
        background: linear-gradient(135deg, rgba(220, 53, 69, 0.1) 0%, rgba(255, 87, 34, 0.1) 100%);
        border-left-color: #dc3545;
      }

      /* Адаптивность плашки */
      @media (max-width: 1400px) {
        .editor-layout {
          grid-template-columns: 35% 12px calc(65% - 12px);
        }
      }

      @media (max-width: 1200px) {
        .interview-sidebar {
          width: 320px;
          max-width: 320px;
        }
        
        .interview-sidebar:not(.collapsed) {
          max-height: calc(100vh - 100px);
        }
      }

      @media (max-width: 768px) {
        .interview-sidebar {
          width: calc(100% - 32px);
          right: 16px;
          left: 16px;
          bottom: 16px;
        }
        
        .interview-sidebar.collapsed {
          width: auto;
          min-width: 180px;
          right: 16px;
          left: auto;
        }

        .interview-sidebar:not(.collapsed) {
          max-height: calc(100vh - 100px);
        }

        .editor-layout {
          grid-template-columns: 100%;
        }
      }

      .task-panel {
        display: flex;
        flex-direction: column;
        background: var(--color-surface, #ffffff);
        overflow: hidden;
        height: 100%;
        border: 1px solid rgba(0, 0, 0, 0.1);
        border-radius: var(--border-radius-lg, 16px);
        box-shadow: var(--shadow-level-2, 0 8px 24px rgba(0, 0, 0, 0.1));
        margin: 12px;
        margin-right: 6px;
      }

      .code-output-container {
        display: flex;
        flex-direction: column;
        gap: 12px;
        overflow: hidden;
        height: 100%;
        background: transparent;
        margin: 12px;
        margin-left: 6px;
      }

      .editor-panel {
        display: flex;
        flex-direction: column;
        background: var(--color-surface, #ffffff);
        overflow: hidden;
        flex: 1;
        min-height: 300px;
        height: 100%;
        border: 1px solid rgba(0, 0, 0, 0.1);
        border-radius: var(--border-radius-lg, 16px);
        box-shadow: var(--shadow-level-2, 0 8px 24px rgba(0, 0, 0, 0.1));
      }

      .task-selector {
        padding: 16px 24px;
        background: transparent;
        border-bottom: 1px solid rgba(0, 0, 0, 0.06);
        flex-shrink: 0;
      }

      .task-selector label {
        display: block;
        margin-bottom: 10px;
        font-weight: 500;
        color: #495057;
        font-size: 14px;
      }

      .task-selector select {
        width: 100%;
        padding: 10px 16px;
        border-radius: var(--border-radius-md, 12px);
        background: var(--color-surface, #ffffff);
        color: var(--color-on-surface, #212529);
        border: 1px solid rgba(0, 0, 0, 0.08);
        font-family: var(--font-family-body, 'Roboto Mono', monospace);
        font-size: 14px;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: var(--shadow-level-1, 0 0 8px rgba(0, 0, 0, 0.05));
      }

      .task-selector select:hover {
        border-color: var(--color-primary, #0066ff);
        box-shadow: var(--shadow-level-2, 0 0 18px rgba(0, 102, 255, 0.15));
        transform: translateY(-1px);
      }

      .task-selector select:focus {
        outline: none;
        border-color: var(--color-primary, #0066ff);
        box-shadow: 0 0 0 3px rgba(0, 102, 255, 0.1), var(--shadow-level-2);
      }

      .task-description {
        flex: 1;
        padding: 24px;
        padding-bottom: 32px;
        background: transparent;
        overflow-y: auto;
        color: #212529;
        line-height: 1.8;
        white-space: pre-wrap;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        font-size: 15px;
        min-height: 0;
      }

      .task-description h3 {
        margin-top: 24px;
        margin-bottom: 12px;
        font-size: 16px;
        font-weight: 600;
      }

      .task-description code {
        background: var(--color-surface-elevated, #f8f9fa);
        padding: 4px 10px;
        border-radius: var(--border-radius-sm, 6px);
        font-family: var(--font-family-body, 'Roboto Mono', monospace);
        font-size: 14px;
        border: 1px solid rgba(0, 0, 0, 0.05);
        box-shadow: var(--shadow-level-1, 0 0 8px rgba(0, 0, 0, 0.05));
      }

      .task-description::-webkit-scrollbar {
        width: 8px;
      }

      .task-description::-webkit-scrollbar-track {
        background: #f8f9fa;
        border-radius: 10px;
      }

      .task-description::-webkit-scrollbar-thumb {
        background: #dee2e6;
        border-radius: 10px;
        transition: background 0.2s;
      }

      .task-description::-webkit-scrollbar-thumb:hover {
        background: #adb5bd;
      }

      .code-editor-wrapper {
        flex: 1;
        display: flex;
        flex-direction: column;
        min-height: 0;
        position: relative;
        overflow: hidden;
        z-index: 1;
        height: 100%;
      }

      .code-editor-wrapper form {
        flex: 1;
        display: flex;
        flex-direction: column;
        min-height: 0;
        height: 100%;
        width: 100%;
      }

      #code {
        display: none;
      }

      .CodeMirror {
        flex: 1 !important;
        height: 100% !important;
        width: 100% !important;
        font-size: 15px;
        font-family: var(--font-family-body, 'Roboto Mono', monospace);
        background: var(--color-surface, #ffffff);
        color: var(--color-on-surface, #212529);
        border-radius: 0;
        position: relative !important;
        z-index: 1;
        overflow: hidden;
      }

      .CodeMirror-gutter-wrapper {
        position: absolute;
        left: 0;
        top: 0;
        height: 100%;
      }

      .CodeMirror-wrap {
        height: 100% !important;
        width: 100% !important;
      }

      .CodeMirror-scroll {
        padding: 16px 16px 24px 0;
        min-height: 100%;
        max-height: 100%;
        overflow-x: auto;
        overflow-y: auto;
      }

      .CodeMirror-sizer {
        min-height: 100% !important;
      }

      .CodeMirror-scrollbar-filler {
        display: none;
      }

      .CodeMirror-gutters {
        border-right: 1px solid rgba(0, 0, 0, 0.1);
        background-color: #f8f9fa;
        white-space: nowrap;
        position: absolute;
        left: 0;
        top: 0;
        min-height: 100%;
        z-index: 3;
        padding-right: 8px;
        box-sizing: border-box;
        width: auto;
        overflow: visible;
      }

      .CodeMirror-gutter-filler {
        background-color: #f8f9fa;
      }

      .CodeMirror-linenumber {
        color: #adb5bd;
        padding: 0 8px 0 4px;
        min-width: 20px;
        text-align: right;
        white-space: nowrap;
        box-sizing: border-box;
        display: inline-block;
        width: auto;
      }

      .CodeMirror-lines {
        padding-left: 0;
        position: relative;
      }

      .CodeMirror-line {
        padding-left: 12px;
        padding-right: 16px;
      }

      .CodeMirror-code {
        padding-left: 0;
      }

      .CodeMirror-cursor {
        border-left: 2px solid var(--color-primary, #0066ff) !important;
        z-index: 3;
      }

      .CodeMirror-selected {
        background: rgba(0, 102, 255, 0.1) !important;
      }

      .CodeMirror-focused {
        outline: none;
      }

      .CodeMirror-hints {
        background: #ffffff;
        border: 1px solid rgba(0, 0, 0, 0.2);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      }

      .CodeMirror-hint {
        color: #212529;
      }

      .CodeMirror-hint-active {
        background: #e9ecef;
      }

      .code-header {
        padding: 12px 20px;
        background: var(--color-surface, #ffffff);
        border-bottom: 1px solid rgba(0, 0, 0, 0.06);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.02);
        gap: 12px;
      }

      .code-header-left {
        display: flex;
        align-items: center;
        gap: 16px;
      }

      .lang-selector {
        padding: 8px 16px;
        border: 1px solid rgba(0, 0, 0, 0.08);
        border-radius: var(--border-radius-md, 12px);
        background: var(--color-surface, #ffffff);
        font-size: 14px;
        color: var(--color-on-surface, #212529);
        font-family: var(--font-family-body, 'Roboto Mono', monospace);
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: var(--shadow-level-1, 0 0 8px rgba(0, 0, 0, 0.05));
      }

      .lang-selector:hover {
        border-color: var(--color-primary, #0066ff);
        box-shadow: var(--shadow-level-2, 0 0 18px rgba(0, 102, 255, 0.15));
        transform: translateY(-1px);
      }

      .resizer {
        width: 12px;
        background: transparent;
        cursor: col-resize;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        grid-column: 2;
        position: relative;
      }

      .resizer::before {
        content: '';
        position: absolute;
        left: 50%;
        top: 0;
        bottom: 0;
        width: 2px;
        background: rgba(0, 0, 0, 0.1);
        transform: translateX(-50%);
        transition: all 0.3s ease;
      }

      .resizer:hover::before {
        background: linear-gradient(to bottom, var(--color-primary, #0066ff), var(--color-accent, #00a3b8));
        width: 4px;
        box-shadow: 0 0 8px rgba(0, 102, 255, 0.3);
      }

      .vertical-resizer {
        width: 100%;
        height: 12px;
        background: transparent;
        cursor: row-resize;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        flex-shrink: 0;
        position: relative;
        margin: 0;
      }

      .vertical-resizer::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 0;
        right: 0;
        height: 2px;
        background: rgba(0, 0, 0, 0.1);
        transform: translateY(-50%);
        transition: all 0.3s ease;
      }

      .vertical-resizer:hover::before {
        background: linear-gradient(to right, var(--color-primary, #0066ff), var(--color-accent, #00a3b8));
        height: 4px;
        box-shadow: 0 0 8px rgba(0, 102, 255, 0.3);
      }

      .output-panel {
        display: flex;
        flex-direction: column;
        flex: 0 0 250px;
        min-height: 200px;
        max-height: 400px;
        background: var(--color-surface, #ffffff);
        border: 1px solid rgba(0, 0, 0, 0.1);
        border-radius: var(--border-radius-lg, 16px);
        box-shadow: var(--shadow-level-2, 0 8px 24px rgba(0, 0, 0, 0.1));
        overflow: hidden;
      }

      .output-tabs {
        display: flex;
        background: #ffffff;
        border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        flex-shrink: 0;
      }

      .output-tab {
        padding: 12px 24px;
        background: transparent;
        border: none;
        border-bottom: 3px solid transparent;
        cursor: pointer;
        font-size: 14px;
        font-weight: var(--font-weight-medium, 500);
        color: var(--color-on-surface-secondary, #6c757d);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border-radius: var(--border-radius-md, 12px) var(--border-radius-md, 12px) 0 0;
        font-family: var(--font-family-body, 'Roboto Mono', monospace);
      }

      .output-tab.active {
        color: var(--color-primary, #0066ff);
        border-bottom-color: var(--color-primary, #0066ff);
        background: linear-gradient(to bottom, rgba(0, 102, 255, 0.08), transparent);
      }

      .output-tab:hover {
        color: var(--color-on-surface, #212529);
        background: rgba(0, 0, 0, 0.03);
        transform: translateY(-1px);
      }

      .output-content {
        flex: 1;
        padding: 16px 20px;
        padding-bottom: 24px;
        overflow-y: auto;
        background: #ffffff;
        color: #212529;
        font-family: 'Roboto Mono', monospace;
        font-size: 13px;
        line-height: 1.6;
        white-space: pre-wrap;
        min-height: 0;
        display: none;
        flex-direction: column;
      }
      
      .output-content pre {
        padding-bottom: 8px;
      }
      
      .output-content.active {
        display: flex;
      }

      .output-content pre {
        margin: 0;
        white-space: pre-wrap;
        word-wrap: break-word;
      }

      .output-content::-webkit-scrollbar {
        width: 8px;
      }

      .output-content::-webkit-scrollbar-track {
        background: #f8f9fa;
        border-radius: 10px;
      }

      .output-content::-webkit-scrollbar-thumb {
        background: #dee2e6;
        border-radius: 10px;
        transition: background 0.2s;
      }

      .output-content::-webkit-scrollbar-thumb:hover {
        background: #adb5bd;
      }
      
      .input-section {
        display: flex;
        flex-direction: column;
        height: 100%;
        gap: 12px;
      }
      
      .input-label {
        font-size: 14px;
        font-weight: 600;
        color: var(--color-on-surface, #212529);
        margin-bottom: 4px;
      }
      
      .user-input-field {
        flex: 1;
        width: 100%;
        padding: 12px;
        padding-bottom: 16px;
        border: 1px solid rgba(0, 0, 0, 0.1);
        border-radius: var(--border-radius-md, 12px);
        background: var(--color-surface, #ffffff);
        color: var(--color-on-surface, #212529);
        font-family: 'Roboto Mono', monospace;
        font-size: 13px;
        line-height: 1.6;
        resize: none;
        min-height: 150px;
        box-sizing: border-box;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }
      
      .user-input-field:focus {
        outline: none;
        border-color: var(--color-primary, #0066ff);
        box-shadow: 0 0 0 3px rgba(0, 102, 255, 0.1);
      }
      
      .user-input-field::placeholder {
        color: #adb5bd;
      }
      
      .input-hint {
        font-size: 12px;
        color: var(--color-on-surface-secondary, #6c757d);
        margin: 0;
        font-style: italic;
      }
      
      .testcases-info {
        padding: 0;
        display: flex;
        flex-direction: column;
        gap: 12px;
        height: 100%;
        overflow: hidden;
      }
      
      .test-result {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 10px 14px;
        background: var(--color-surface-elevated, #f8f9fa);
        border-radius: var(--border-radius-md, 12px);
        border: 1px solid rgba(0, 0, 0, 0.05);
        flex-shrink: 0;
      }
      
      .test-result-label {
        font-size: 14px;
        font-weight: 500;
        color: var(--color-on-surface, #212529);
      }
      
      .test-result-value {
        font-size: 16px;
        font-weight: 600;
        color: var(--color-primary, #0066ff);
        font-family: 'Roboto Mono', monospace;
      }
      
      .test-results-list {
        margin-top: 0;
        display: flex;
        flex-direction: column;
        gap: 12px;
        flex: 1;
        overflow-y: auto;
        min-height: 0;
        padding-bottom: 16px;
      }
      
      .test-item {
        padding: 12px 14px;
        border-radius: var(--border-radius-md, 12px);
        border: 1px solid rgba(0, 0, 0, 0.1);
        background: var(--color-surface, #ffffff);
      }
      
      .test-item.test-passed {
        border-left: 4px solid #28a745;
        background: rgba(40, 167, 69, 0.05);
      }
      
      .test-item.test-failed {
        border-left: 4px solid #dc3545;
        background: rgba(220, 53, 69, 0.05);
      }
      
      .test-item.test-timeout {
        border-left: 4px solid #ffc107;
        background: rgba(255, 193, 7, 0.05);
      }
      
      .test-item-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
        padding-bottom: 6px;
        border-bottom: 1px solid rgba(0, 0, 0, 0.1);
      }
      
      .test-item-number {
        font-size: 14px;
        font-weight: 600;
        color: var(--color-on-surface, #212529);
      }
      
      .test-item-status {
        font-size: 13px;
        font-weight: 500;
        font-family: 'Roboto Mono', monospace;
      }
      
      .test-item.test-passed .test-item-status {
        color: #28a745;
      }
      
      .test-item.test-failed .test-item-status {
        color: #dc3545;
      }
      
      .test-item.test-timeout .test-item-status {
        color: #ffc107;
      }
      
      .test-item-details {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }
      
      .test-detail-row {
        display: flex;
        gap: 12px;
        font-size: 13px;
        line-height: 1.6;
      }
      
      .test-detail-label {
        font-weight: 500;
        color: var(--color-on-surface-secondary, #6c757d);
        min-width: 100px;
        flex-shrink: 0;
      }
      
      .test-detail-value {
        color: var(--color-on-surface, #212529);
        font-family: 'Roboto Mono', monospace;
        word-break: break-word;
        flex: 1;
      }
      
      .test-detail-value.test-error {
        color: #dc3545;
        background: rgba(220, 53, 69, 0.1);
        padding: 4px 8px;
        border-radius: 4px;
      }
      
      .test-results-list::-webkit-scrollbar {
        width: 8px;
      }
      
      .test-results-list::-webkit-scrollbar-track {
        background: #f8f9fa;
        border-radius: 10px;
      }
      
      .test-results-list::-webkit-scrollbar-thumb {
        background: #dee2e6;
        border-radius: 10px;
        transition: background 0.2s;
      }
      
      .test-results-list::-webkit-scrollbar-thumb:hover {
        background: #adb5bd;
      }

      .btn-run {
        background: linear-gradient(135deg, var(--color-primary, #0066ff) 0%, var(--color-accent, #00a3b8) 100%);
        color: var(--color-on-primary, #ffffff);
        border: none;
        padding: 10px 24px;
        border-radius: var(--border-radius-md, 12px);
        font-weight: var(--font-weight-medium, 500);
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        font-size: 14px;
        font-family: var(--font-family-body, 'Roboto Mono', monospace);
        box-shadow: var(--shadow-level-2, 0 4px 16px rgba(0, 102, 255, 0.25));
      }

      .btn-run:hover {
        background: linear-gradient(135deg, var(--color-accent, #00a3b8) 0%, var(--color-primary, #0066ff) 100%);
        transform: translateY(-2px);
        box-shadow: var(--shadow-level-3, 0 8px 24px rgba(0, 102, 255, 0.35));
      }

      .btn-run:active {
        transform: translateY(0);
        box-shadow: var(--shadow-level-1, 0 2px 8px rgba(0, 102, 255, 0.25));
      }

      .btn-test {
        background: transparent;
        color: var(--color-primary, #0066ff);
        border: 1px solid var(--color-primary, #0066ff);
        padding: 10px 24px;
        border-radius: var(--border-radius-md, 12px);
        font-weight: var(--font-weight-medium, 500);
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        font-size: 14px;
        font-family: var(--font-family-body, 'Roboto Mono', monospace);
        box-shadow: var(--shadow-level-1, 0 2px 8px rgba(0, 102, 255, 0.15));
      }

      .btn-test:hover {
        background: rgba(0, 102, 255, 0.08);
        transform: translateY(-2px);
        box-shadow: var(--shadow-level-2, 0 4px 16px rgba(0, 102, 255, 0.25));
      }

      .btn-test:active {
        transform: translateY(0);
        box-shadow: var(--shadow-level-1, 0 2px 8px rgba(0, 102, 255, 0.15));
      }

      .code-actions {
        display: flex;
        gap: 12px;
      }

      @media (max-width: 1200px) {
        .editor-layout {
          grid-template-columns: 1fr;
          grid-template-rows: 300px 5px 1fr;
          height: auto;
          min-height: calc(100vh - 150px);
        }

        .task-panel {
          border-right: none;
          border-bottom: 1px solid rgba(0, 0, 0, 0.1);
          margin: 12px;
        }

        .code-output-container {
          border-radius: 0;
          margin: 12px;
        }

        .editor-panel {
          border-radius: 0;
          min-height: 400px;
        }

        .output-panel {
          border-radius: 0;
          flex: 0 0 200px;
          max-height: 300px;
        }

        .resizer {
          width: 100%;
          height: 5px;
          cursor: row-resize;
        }

        .resizer-1 {
          grid-column: 1 !important;
          grid-row: 2;
        }

        .vertical-resizer {
          width: 100%;
        }

        .code-header {
          padding: 10px 16px;
          flex-direction: column;
          align-items: stretch;
          gap: 8px;
        }

        .code-header-left {
          width: 100%;
        }

        .lang-selector {
          width: 100%;
          padding: 6px 12px;
          font-size: 13px;
        }

        .btn-run, .btn-test {
          width: 100%;
          padding: 10px;
          font-size: 14px;
        }

        .CodeMirror {
          font-size: 14px;
        }

        .CodeMirror-scroll {
          padding: 12px 12px 20px 0;
        }

        .CodeMirror-gutters {
          padding-right: 6px;
        }

        .CodeMirror-linenumber {
          padding: 0 6px 0 3px;
          font-size: 12px;
        }

        .CodeMirror-line {
          padding-left: 10px;
        }
      }

      @media (max-width: 768px) {
        .editor-section {
          height: calc(100vh - 60px);
        }

        .editor-layout {
          grid-template-rows: 250px 5px 1fr;
          min-height: calc(100vh - 120px);
        }

        .task-panel {
          margin: 8px;
          border-radius: 12px;
        }

        .code-output-container {
          margin: 8px;
        }

        .editor-panel {
          min-height: 350px;
          border-radius: 12px;
        }

        .output-panel {
          flex: 0 0 180px;
          max-height: 250px;
          border-radius: 12px;
        }

        .code-header {
          padding: 8px 12px;
          flex-direction: column;
          align-items: stretch;
          gap: 8px;
        }

        .CodeMirror {
          font-size: 13px;
        }

        .CodeMirror-scroll {
          padding: 10px 10px 16px 0;
        }

        .output-tab {
          padding: 10px 16px;
          font-size: 13px;
        }

        .output-content {
          padding: 12px 16px;
          padding-bottom: 20px;
          font-size: 12px;
        }
        
        .user-input-field {
          font-size: 12px;
          padding: 10px;
          min-height: 120px;
        }
        
        .input-label {
          font-size: 13px;
        }
        
        .input-hint {
          font-size: 11px;
        }

        .task-selector {
          padding: 12px 16px;
        }

        .task-description {
          padding: 16px;
          padding-bottom: 24px;
          font-size: 14px;
        }
        
        .test-item {
          padding: 12px;
        }
        
        .test-item-header {
          flex-direction: column;
          align-items: flex-start;
          gap: 8px;
        }
        
        .test-detail-row {
          flex-direction: column;
          gap: 4px;
        }
        
        .test-detail-label {
          min-width: auto;
        }
      }

      @media (max-width: 480px) {
        .editor-section {
          height: calc(100vh - 50px);
        }

        .editor-layout {
          grid-template-rows: 200px 4px 1fr;
          min-height: calc(100vh - 100px);
        }

        .task-panel {
          margin: 4px;
          border-radius: 8px;
        }

        .code-output-container {
          margin: 4px;
        }

        .editor-panel {
          min-height: 300px;
          border-radius: 8px;
        }

        .output-panel {
          flex: 0 0 150px;
          max-height: 200px;
          border-radius: 8px;
        }

        .code-header {
          padding: 6px 10px;
        }

        .CodeMirror {
          font-size: 12px;
        }

        .CodeMirror-scroll {
          padding: 8px 8px 8px 0;
        }

        .CodeMirror-gutters {
          padding-right: 4px;
        }

        .CodeMirror-linenumber {
          padding: 0 4px 0 2px;
          font-size: 11px;
          min-width: 18px;
        }

        .CodeMirror-line {
          padding-left: 8px;
        }

        .output-tab {
          padding: 8px 12px;
          font-size: 12px;
        }

        .output-content {
          padding: 10px 12px;
          padding-bottom: 16px;
          font-size: 11px;
        }
        
        .user-input-field {
          font-size: 11px;
          padding: 8px;
          min-height: 100px;
        }
        
        .input-label {
          font-size: 12px;
        }
        
        .input-hint {
          font-size: 10px;
        }
        
        .output-tab {
          padding: 8px 12px;
          font-size: 12px;
        }
        
        .test-item {
          padding: 10px;
        }
        
        .test-item-header {
          flex-direction: column;
          align-items: flex-start;
          gap: 6px;
        }
        
        .test-detail-row {
          flex-direction: column;
          gap: 4px;
          font-size: 12px;
        }
        
        .test-detail-label {
          min-width: auto;
          font-size: 12px;
        }
        
        .test-detail-value {
          font-size: 11px;
        }
      }

      @media (min-width: 1400px) {
        .editor-layout {
          grid-template-columns: 35% 12px 65%;
        }

        .CodeMirror {
          font-size: 16px;
        }

        .CodeMirror-scroll {
          padding: 20px 20px 20px 0;
        }

        .CodeMirror-gutters {
          padding-right: 10px;
        }

        .CodeMirror-linenumber {
          padding: 0 10px 0 5px;
          font-size: 15px;
        }

        .CodeMirror-line {
          padding-left: 14px;
        }
      }
    </style>
</head>
<body>
    <!-- Navigation -->
    <navigation-wrapper class="navigation-wrapper">
        <div class="navigation-container1">
            <nav id="mainNavigation" class="navigation">
                <div class="navigation-container">
                    <div class="navigation-left">
                        <a href="{% url 'home' %}">
                            <div class="navigation-link"><span>Главная</span></div>
                        </a>
                        {% if user.is_authenticated and user.is_candidate %}
                            {% if show_interview_link %}
                            <a href="{% url 'interview' %}">
                                <div class="navigation-link"><span>Интервью</span></div>
                            </a>
                            {% endif %}
                            {% if show_editor_link %}
                            <a href="{% url 'runcode' %}">
                                <div class="navigation-link"><span>Редактор</span></div>
                            </a>
                            {% endif %}
                        {% elif user.is_authenticated and user.is_hr %}
                            <a href="{% url 'hr_dashboard' %}">
                                <div class="navigation-link"><span>Панель HR</span></div>
                            </a>
                        {% else %}
                            <a href="{% url 'runcode' %}">
                                <div class="navigation-link"><span>Редактор</span></div>
                            </a>
                        {% endif %}
                    </div>
                    <a href="{% url 'home' %}">
                        <div class="navigation-logo">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" class="navigation-logo-icon">
                                <path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m16 18l6-6l-6-6M8 6l-6 6l6 6"></path>
                            </svg>
                            <span class="navigation-logo-text">CodeSphere</span>
                        </div>
                    </a>
                    <div class="navigation-right">
                        {% if user.is_authenticated %}
                            <span class="navigation-link" style="color: var(--color-on-surface-secondary, #6c757d); margin-right: 12px;">
                                {{ user.username }} ({{ user.get_role_display }})
                            </span>
                            <a href="{% url 'logout' %}">
                                <div class="navigation-link"><span>Выйти</span></div>
                            </a>
                        {% else %}
                            <a href="{% url 'login' %}">
                                <div class="navigation-link"><span>Вход</span></div>
                            </a>
                            <a href="{% url 'register' %}">
                                <div class="navigation-cta btn btn-primary">
                                    <span>Регистрация</span>
                                </div>
                            </a>
                        {% endif %}
                    </div>
                    <button id="navToggle" aria-expanded="false" aria-label="Открыть меню навигации" class="navigation-toggle">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
                            <path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5h16M4 12h16M4 19h16"></path>
                        </svg>
                    </button>
                </div>
            </nav>
            <div id="navMobileOverlay" class="navigation-mobile-overlay">
                <div class="navigation-mobile-header">
                    <a href="{% url 'home' %}">
                        <div class="navigation-mobile-logo">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" class="navigation-mobile-logo-icon">
                                <path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m16 18l6-6l-6-6M8 6l-6 6l6 6"></path>
                            </svg>
                            <span class="navigation-mobile-logo-text">CodeSphere</span>
                        </div>
                    </a>
                    <button id="navClose" aria-label="Закрыть меню навигации" class="navigation-close">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
                            <path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 6L6 18M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <div class="navigation-mobile-content">
                    <a href="{% url 'home' %}">
                        <div class="navigation-mobile-link"><span>Главная</span></div>
                    </a>
                    {% if user.is_authenticated and user.is_candidate %}
                        {% if show_interview_link %}
                        <a href="{% url 'interview' %}">
                            <div class="navigation-mobile-link"><span>Интервью</span></div>
                        </a>
                        {% endif %}
                        {% if show_editor_link %}
                        <a href="{% url 'runcode' %}">
                            <div class="navigation-mobile-link"><span>Редактор</span></div>
                        </a>
                        {% endif %}
                    {% else %}
                        <a href="{% url 'runcode' %}">
                            <div class="navigation-mobile-link"><span>Редактор</span></div>
                        </a>
                    {% endif %}
                    {% if user.is_authenticated %}
                        <div class="navigation-mobile-link" style="color: var(--color-on-surface-secondary, #6c757d);">
                            <span>{{ user.username }} ({{ user.get_role_display }})</span>
                        </div>
                        <a href="{% url 'logout' %}">
                            <div class="navigation-mobile-link"><span>Выйти</span></div>
                        </a>
                    {% else %}
                        <a href="{% url 'login' %}">
                            <div class="navigation-mobile-link"><span>Вход</span></div>
                        </a>
                        <a href="{% url 'register' %}">
                            <div class="navigation-mobile-cta btn btn-primary"><span>Регистрация</span></div>
                        </a>
                    {% endif %}
                </div>
            </div>
            <div class="navigation-container2">
                <div class="navigation-container3">
                    <script defer="" data-name="navigation-toggle">
                      document.addEventListener('DOMContentLoaded', function() {
                        (function(){
                          const navToggle = document.getElementById("navToggle")
                          const navClose = document.getElementById("navClose")
                          const navMobileOverlay = document.getElementById("navMobileOverlay")

                          function openMobileNav() {
                            navMobileOverlay.classList.add("navigation-mobile-active")
                            navToggle.setAttribute("aria-expanded", "true")
                            document.body.style.overflow = "hidden"
                          }

                          function closeMobileNav() {
                            navMobileOverlay.classList.remove("navigation-mobile-active")
                            navToggle.setAttribute("aria-expanded", "false")
                            document.body.style.overflow = ""
                          }

                          navToggle.addEventListener("click", openMobileNav)
                          navClose.addEventListener("click", closeMobileNav)

                          const mobileLinks = document.querySelectorAll(
                            ".navigation-mobile-link, .navigation-mobile-cta"
                          )
                          mobileLinks.forEach((link) => {
                            link.addEventListener("click", closeMobileNav)
                          })
                        })()
                      });
                    </script>
                </div>
            </div>
        </div>
    </navigation-wrapper>

    <!-- Editor Section -->
    <section class="editor-section">
        <div class="editor-container">
            <div class="editor-layout">
                <!-- Task Panel (Left) -->
                <div class="task-panel" id="task-panel">
                    <div class="task-selector">
                        <label for="task-select">Задача:</label>
                        <form method="get" id="task-form">
                            <select id="task-select" name="task" onchange="this.form.submit()">
                                {% for task_file in tasks %}
                                    <option value="{{ task_file }}" {% if task_file == selected_task %}selected{% endif %}>{{ task_file }}</option>
                                {% endfor %}
                            </select>
                        </form>
                    </div>
                    {% if task_text %}
                        <div class="task-description">
                            {{ task_text|linebreaks }}
                        </div>
                    {% else %}
                        <div class="task-description" style="display: flex; align-items: center; justify-content: center; color: #6c757d;">
                            Выберите задачу из списка выше
                        </div>
                    {% endif %}
                </div>
                <div class="resizer" id="resizer1"></div>
                <!-- Code Editor and Output Container -->
                <div class="code-output-container" id="code-output-container">
                    <!-- Code Editor Panel -->
                    <div class="editor-panel" id="code-panel">
                        <div class="code-header">
                            <div class="code-header-left">
                                <select class="lang-selector" id="language-selector">
                                    <option value="Python" {% if language == "Python" %}selected{% endif %}>Python</option>
                                    <option value="C++" {% if language == "C++" %}selected{% endif %}>C++</option>
                                </select>
                            </div>
                            <div class="code-actions">
                                <button type="submit" name="mode" value="run_code" form="code-form" class="btn-run">▶ Запустить</button>
                                <button type="submit" name="mode" value="run_tests" form="code-form" class="btn-test">Проверить тесты</button>
                            </div>
                        </div>
                        <div class="code-editor-wrapper">
                            <form method="post" action="{% url 'run_code' %}" id="code-form">
                                {% csrf_token %}
                                <input type="hidden" name="task" value="{{ selected_task }}">
                                <input type="hidden" name="language" id="language-input" value="{{ language|default:'Python' }}">
                                <textarea id="code" name="code">{{ code|default:"" }}</textarea>
                                <textarea id="input_data" name="input_data" style="display: none;">{{ input_data|default:"" }}</textarea>
                            </form>
                        </div>
                    </div>
                    <div class="vertical-resizer" id="vertical-resizer"></div>
                    <!-- Output Panel -->
                    <div class="output-panel" id="output-panel">
                        <div class="output-tabs">
                            <button class="output-tab {% if not test_mode %}active{% endif %}" onclick="switchTab('output')">Вывод</button>
                            <button class="output-tab" onclick="switchTab('input')">Ввод</button>
                            <button class="output-tab {% if test_mode %}active{% endif %}" onclick="switchTab('testcases')">Тест-кейсы</button>
                        </div>
                        <div class="output-content {% if not test_mode %}active{% endif %}" id="output-content" {% if test_mode %}style="display: none;"{% endif %}>
                            <pre id="output">{% if code_executed %}{{ output|default:"Код выполнен успешно. Вывод пуст." }}{% else %}Запустите код, чтобы увидеть результат...{% endif %}</pre>
                        </div>
                        <div class="output-content" id="input-content" style="display: none;">
                            <div class="input-section">
                                <label for="user-input" class="input-label">Входные данные:</label>
                                <textarea id="user-input" name="input_data" form="code-form" class="user-input-field" placeholder="Введите данные для программы (каждое значение на новой строке или через пробел)">{{ input_data|default:"" }}</textarea>
                                <p class="input-hint">Данные будут переданы в программу через stdin</p>
                            </div>
                        </div>
                        <div class="output-content {% if test_mode %}active{% endif %}" id="testcases-content" {% if not test_mode %}style="display: none;"{% endif %}>
                            <div class="testcases-info">
                                {% if tests_passed %}
                                    <div class="test-result">
                                        <span class="test-result-label">Пройдено тестов:</span>
                                        <span class="test-result-value">{{ tests_passed }}</span>
                                    </div>
                                {% elif not test_results %}
                                    <div class="test-result">
                                        <p style="margin: 0; color: var(--color-on-surface-secondary, #6c757d);">Нажмите "Проверить тесты" для запуска тестов</p>
                                    </div>
                                {% endif %}
                                
                                {% if test_results %}
                                    <div class="test-results-list">
                                        {% for result in test_results %}
                                            <div class="test-item {% if result.passed %}test-passed{% elif result.timeout %}test-timeout{% else %}test-failed{% endif %}">
                                                <div class="test-item-header">
                                                    <span class="test-item-number">Тест {{ result.number }}</span>
                                                    <span class="test-item-status">
                                                        {% if result.passed %}
                                                            ✓ Пройден
                                                        {% elif result.timeout %}
                                                            ✗ Таймаут
                                                        {% else %}
                                                            ✗ Не пройден
                                                        {% endif %}
                                                    </span>
                                                </div>
                                                <div class="test-item-details">
                                                    <div class="test-detail-row">
                                                        <span class="test-detail-label">Вход:</span>
                                                        <span class="test-detail-value">{{ result.input|default:"(нет)" }}</span>
                                                    </div>
                                                    <div class="test-detail-row">
                                                        <span class="test-detail-label">Ожидалось:</span>
                                                        <span class="test-detail-value">{{ result.expected|default:"(нет)" }}</span>
                                                    </div>
                                                    <div class="test-detail-row">
                                                        <span class="test-detail-label">Получено:</span>
                                                        <span class="test-detail-value">{{ result.actual|default:"(нет)" }}</span>
                                                    </div>
                                                    {% if result.error %}
                                                        <div class="test-detail-row">
                                                            <span class="test-detail-label">Ошибка:</span>
                                                            <span class="test-detail-value test-error">{{ result.error }}</span>
                                                        </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Плашка интервью/чат справа (показывается после завершения теории) -->
        {% if theory_completed %}
        <div class="interview-sidebar" id="interviewSidebar">
            <div class="interview-sidebar-header" onclick="toggleInterviewSidebar()">
                <span>💬 Чат с интервьюером</span>
                <button class="interview-sidebar-toggle" aria-label="Свернуть/развернуть">▼</button>
            </div>
            <div class="interview-sidebar-content" id="chatContent">
                <!-- История чата будет здесь -->
                <div id="chatMessages">
                    {% for item in interview_chat_history %}
                        {% if item.type == 'theory_qa' %}
                            <div class="interview-message">
                                <div class="interview-message-question">
                                    <div class="interview-message-label">💬 Вопрос</div>
                                    <div>{{ item.question }}</div>
                                </div>
                                <div class="interview-message-answer">
                                    <div class="interview-message-label">✍️ Ваш ответ</div>
                                    <div>{{ item.answer }}</div>
                                </div>
                            </div>
                        {% elif item.type == 'code_feedback' %}
                            <div class="interview-message">
                                <div class="interview-message-question">
                                    <div class="interview-message-label">🔍 Обратная связь</div>
                                    <div>{{ item.feedback }}</div>
                                    {% if item.hint %}
                                        <div style="margin-top: 8px; padding: 8px; background: rgba(255, 193, 7, 0.1); border-radius: 6px; border-left: 3px solid #ffc107;">
                                            <strong>💡 Подсказка:</strong> {{ item.hint }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        {% elif item.type == 'chat_message' %}
                            {% if item.role == 'candidate' %}
                                <div class="interview-message">
                                    <div class="interview-message-answer">
                                        <div class="interview-message-label">✍️ Вы</div>
                                        <div>{{ item.content }}</div>
                                    </div>
                                </div>
                            {% else %}
                                <div class="interview-message">
                                    <div class="interview-message-question">
                                        <div class="interview-message-label">👨‍💻 Интервьюер</div>
                                        <div>{{ item.content }}</div>
                                    </div>
                                </div>
                            {% endif %}
                        {% endif %}
                    {% empty %}
                        <div class="chat-welcome" id="chatWelcome">
                            <p style="color: #6c757d; text-align: center; padding: 20px;">
                                👋 Привет! Я буду помогать вам во время решения задач.<br><br>
                                Запустите тесты, и я дам обратную связь по вашему коду.
                            </p>
                        </div>
                    {% endfor %}
                </div>
            </div>
            <!-- Поле ввода сообщения -->
            <div class="chat-input-container" id="chatInputContainer">
                <input type="text" id="chatInput" class="chat-input" placeholder="Задайте вопрос..." />
                <button id="chatSendBtn" class="chat-send-btn" onclick="sendChatMessage()">➤</button>
            </div>
        </div>
        {% endif %}
    </section>

    <!-- Footer -->
    <footer-wrapper class="footer-wrapper">
        <div class="footer-container1">
            <footer class="footer">
                <div class="footer-wrapper">
                    <div class="footer-content" style="padding: 40px 20px; max-width: 1200px; margin: 0 auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px;">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" style="color: currentColor;">
                                    <path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m16 18l6-6l-6-6M8 6l-6 6l6 6"></path>
                                </svg>
                                <span style="font-weight: 600; font-size: 18px;">CodeSphere</span>
                            </div>
                            <nav style="display: flex; gap: 30px; align-items: center; flex-wrap: wrap;">
                                <a href="{% url 'home' %}" style="text-decoration: none; color: inherit; font-size: 14px;">Главная</a>
                                <a href="{% url 'runcode' %}" style="text-decoration: none; color: inherit; font-size: 14px;">Редактор</a>
                            </nav>
                            <p style="margin: 0; font-size: 14px; color: rgba(0, 0, 0, 0.6);">© 2025 CodeSphere</p>
                        </div>
                    </div>
                </div>
            </footer>
        </div>
    </footer-wrapper>

    <!-- CodeMirror Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/python/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/clike/clike.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/hint/show-hint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/hint/anyword-hint.min.js"></script>

    <script>
      // Initialize CodeMirror after DOM is ready
      document.addEventListener('DOMContentLoaded', function() {
        const textarea = document.getElementById('code');
        const codeEditorWrapper = document.querySelector('.code-editor-wrapper');
        const languageSelector = document.getElementById('language-selector');
        const languageInput = document.getElementById('language-input');

        if (textarea && codeEditorWrapper) {
          console.log('Initializing CodeMirror...');

          // Get initial language
          const initialLanguage = languageInput ? languageInput.value : 'Python';
          const initialMode = initialLanguage === 'C++' ? 'text/x-c++src' : 'python';

          // Create editor
          var editor = CodeMirror.fromTextArea(textarea, {
            mode: initialMode,
            lineNumbers: true,
            indentUnit: 4,
            theme: "eclipse",
            viewportMargin: Infinity,
            extraKeys: {"Ctrl-Space": "autocomplete"},
            lineWrapping: true,
            autoFocus: false,
            lineNumberFormatter: function(line) {
              return line;
            }
          });

          // Store editor globally for resize handlers
          window.editor = editor;

          // Handle language change
          if (languageSelector && languageInput) {
            languageSelector.addEventListener('change', function() {
              const selectedLanguage = this.value;
              const newMode = selectedLanguage === 'C++' ? 'text/x-c++src' : 'python';
              
              // Update CodeMirror mode
              editor.setOption('mode', newMode);
              
              // Force refresh to apply syntax highlighting immediately
              editor.refresh();
              
              // Update hidden input
              languageInput.value = selectedLanguage;
              
              console.log('Language changed to:', selectedLanguage, 'Mode:', newMode);
              
              // Optional: Show a brief visual feedback
              const wrapper = editor.getWrapperElement();
              wrapper.style.transition = 'background-color 0.2s';
              wrapper.style.backgroundColor = 'rgba(0, 102, 255, 0.05)';
              setTimeout(function() {
                wrapper.style.backgroundColor = '';
                setTimeout(function() {
                  wrapper.style.transition = '';
                }, 200);
              }, 200);
            });
          }

          // Function to update gutter width based on line count
          const updateGutterWidth = function(cm) {
            const gutter = cm.getGutterElement();
            if (gutter) {
              const lineCount = cm.lineCount();
              const maxDigits = String(lineCount).length;
              // Calculate width: ~7px per digit + padding (left 4px + right 8px) = 12px
              const minWidth = Math.max(maxDigits * 7 + 16, 40);
              gutter.style.minWidth = minWidth + 'px';
              gutter.style.width = minWidth + 'px';
            }
          };

          // Update gutter width on various events
          editor.on("change", function(cm) {
            updateGutterWidth(cm);
          });

          editor.on("viewportChange", function(cm) {
            updateGutterWidth(cm);
          });

          // Initial gutter width update
          setTimeout(function() {
            updateGutterWidth(editor);
          }, 100);

          // Store editor globally for resize handlers
          window.editor = editor;

          // Make sure editor is visible and clickable
          editor.setOption('readOnly', false);

          // Force editor to be interactive
          editor.getWrapperElement().style.pointerEvents = 'auto';
          editor.getWrapperElement().style.cursor = 'text';

          // Make CodeMirror container fill the form
          const cmElement = editor.getWrapperElement();
          cmElement.style.flex = '1';
          cmElement.style.display = 'flex';
          cmElement.style.flexDirection = 'column';
          cmElement.style.minHeight = '0';
          cmElement.style.height = '100%';
          cmElement.style.width = '100%';

          const cmScroller = cmElement.querySelector('.CodeMirror-scroll');
          if (cmScroller) {
            cmScroller.style.height = '100%';
            cmScroller.style.maxHeight = '100%';
          }

          editor.on("inputRead", function(cm, change) {
            if (change.text[0] && change.text[0].match(/\w/)) {
              CodeMirror.showHint(cm, CodeMirror.hint.anyword, {completeSingle: false});
            }
          });

          // Update textarea before form submit
          const codeForm = document.getElementById('code-form');
          if (codeForm) {
            codeForm.addEventListener('submit', function(e) {
              editor.save();
            });
          }

          // Refresh editor on window resize with debounce
          let resizeTimeout;
          const refreshEditor = function() {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(function() {
              editor.refresh();
              updateGutterWidth(editor);
              const wrapper = editor.getWrapperElement();
              const scroller = wrapper.querySelector('.CodeMirror-scroll');
              if (scroller) {
                scroller.style.height = '100%';
                scroller.style.maxHeight = '100%';
              }
            }, 150);
          };

          window.addEventListener('resize', refreshEditor);

          // Use ResizeObserver for better resize detection
          if (window.ResizeObserver) {
            const resizeObserver = new ResizeObserver(function(entries) {
              refreshEditor();
            });
            const editorWrapper = document.querySelector('.code-editor-wrapper');
            if (editorWrapper) {
              resizeObserver.observe(editorWrapper);
            }
          }

          // Multiple refreshes to ensure it works
          setTimeout(function() {
            editor.refresh();
            updateGutterWidth(editor);
            const wrapper = editor.getWrapperElement();
            const scroller = wrapper.querySelector('.CodeMirror-scroll');
            if (scroller) {
              scroller.style.height = '100%';
              scroller.style.maxHeight = '100%';
            }
          }, 200);

          setTimeout(function() {
            editor.refresh();
            updateGutterWidth(editor);
          }, 500);

          setTimeout(function() {
            editor.refresh();
            updateGutterWidth(editor);
          }, 1000);

          // Click handler to focus editor
          codeEditorWrapper.addEventListener('click', function(e) {
            if (e.target.closest('.CodeMirror')) {
              editor.focus();
            }
          });

          console.log('CodeMirror initialized successfully');
        } else {
          console.error('Textarea or wrapper not found!', {
            textarea: !!textarea,
            wrapper: !!codeEditorWrapper
          });
        }
      });

      // Horizontal resizer (between task and code)
      const resizer1 = document.getElementById('resizer1');
      const taskPanel = document.getElementById('task-panel');
      const layout = document.querySelector('.editor-layout');
      let isResizingHorizontal = false;

      if (resizer1 && window.innerWidth > 1200) {
        resizer1.addEventListener('mousedown', e => {
          isResizingHorizontal = true;
          document.body.style.cursor = 'col-resize';
          document.body.style.userSelect = 'none';
          e.preventDefault();
        });
      }

      // Vertical resizer (between code and output)
      const verticalResizer = document.getElementById('vertical-resizer');
      const codePanel = document.getElementById('code-panel');
      const outputPanel = document.getElementById('output-panel');
      const codeOutputContainer = document.getElementById('code-output-container');
      let isResizingVertical = false;

      if (verticalResizer) {
        verticalResizer.addEventListener('mousedown', e => {
          isResizingVertical = true;
          document.body.style.cursor = 'row-resize';
          document.body.style.userSelect = 'none';
          e.preventDefault();
        });

        // Touch support for mobile
        verticalResizer.addEventListener('touchstart', e => {
          isResizingVertical = true;
          e.preventDefault();
        });
      }

      document.addEventListener('mousemove', e => {
        // Horizontal resize (task panel width) - only on desktop
        if (isResizingHorizontal && window.innerWidth > 1200) {
          const containerRect = layout.getBoundingClientRect();
          let pointerX = e.clientX - containerRect.left;
          const minWidth = 250;
          const maxWidth = containerRect.width - 300;

          if (pointerX < minWidth) pointerX = minWidth;
          if (pointerX > maxWidth) pointerX = maxWidth;

          layout.style.gridTemplateColumns = pointerX + 'px 12px 1fr';
        }

        // Vertical resize (code and output height)
        if (isResizingVertical) {
          const containerRect = codeOutputContainer.getBoundingClientRect();
          let pointerY = e.clientY - containerRect.top;
          const minHeight = 200;
          const maxHeight = containerRect.height - 100;

          if (pointerY < minHeight) pointerY = minHeight;
          if (pointerY > maxHeight) pointerY = maxHeight;

          const outputHeight = containerRect.height - pointerY - 12;
          codePanel.style.flex = '0 0 ' + pointerY + 'px';
          outputPanel.style.flex = '0 0 ' + outputHeight + 'px';

          // Refresh CodeMirror after resize
          if (window.editor) {
            setTimeout(() => window.editor.refresh(), 50);
          }
        }
      });

      document.addEventListener('touchmove', e => {
        if (isResizingVertical && e.touches.length > 0) {
          const containerRect = codeOutputContainer.getBoundingClientRect();
          let pointerY = e.touches[0].clientY - containerRect.top;
          const minHeight = 200;
          const maxHeight = containerRect.height - 100;

          if (pointerY < minHeight) pointerY = minHeight;
          if (pointerY > maxHeight) pointerY = maxHeight;

          const outputHeight = containerRect.height - pointerY - 12;
          codePanel.style.flex = '0 0 ' + pointerY + 'px';
          outputPanel.style.flex = '0 0 ' + outputHeight + 'px';

          e.preventDefault();
        }
      });

      document.addEventListener('mouseup', e => {
        if (isResizingHorizontal || isResizingVertical) {
          isResizingHorizontal = false;
          isResizingVertical = false;
          document.body.style.cursor = '';
          document.body.style.userSelect = '';

          // Refresh CodeMirror after resize
          if (window.editor) {
            setTimeout(() => window.editor.refresh(), 100);
          }
        }
      });

      document.addEventListener('touchend', e => {
        if (isResizingVertical) {
          isResizingVertical = false;
          if (window.editor) {
            setTimeout(() => window.editor.refresh(), 100);
          }
        }
      });

      // Handle window resize to reset layout on mobile
      let resizeTimeout;
      window.addEventListener('resize', function() {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(function() {
          if (window.innerWidth <= 1200) {
            // Reset to default layout on mobile
            if (layout) {
              layout.style.gridTemplateColumns = '';
            }
            if (codePanel) {
              codePanel.style.flex = '';
            }
            if (outputPanel) {
              outputPanel.style.flex = '';
            }
          }
          // Refresh editor
          if (window.editor) {
            window.editor.refresh();
          }
        }, 200);
      });

      // Tab switching
      function switchTab(tabName) {
        const tabs = document.querySelectorAll('.output-tab');
        const contents = document.querySelectorAll('.output-content');
        
        // Remove active class from all tabs and contents
        tabs.forEach(tab => tab.classList.remove('active'));
        contents.forEach(content => {
          content.classList.remove('active');
          content.style.display = 'none';
        });
        
        // Activate selected tab and content
        if (tabName === 'output') {
          tabs[0].classList.add('active');
          const outputContent = document.getElementById('output-content');
          if (outputContent) {
            outputContent.classList.add('active');
            outputContent.style.display = 'flex';
          }
        } else if (tabName === 'input') {
          tabs[1].classList.add('active');
          const inputContent = document.getElementById('input-content');
          if (inputContent) {
            inputContent.classList.add('active');
            inputContent.style.display = 'flex';
          }
        } else if (tabName === 'testcases') {
          tabs[2].classList.add('active');
          const testcasesContent = document.getElementById('testcases-content');
          if (testcasesContent) {
            testcasesContent.classList.add('active');
            testcasesContent.style.display = 'flex';
          }
        }
      }
      
      // Sync textarea with hidden input and form submission
      // Функция для сворачивания/разворачивания плашки интервью
      function toggleInterviewSidebar() {
        const sidebar = document.getElementById('interviewSidebar');
        if (sidebar) {
          sidebar.classList.toggle('collapsed');
        }
      }

      // Показать плашку интервью с анимацией
      document.addEventListener('DOMContentLoaded', function() {
        const interviewSidebar = document.getElementById('interviewSidebar');
        if (interviewSidebar) {
          // Небольшая задержка для плавного появления
          setTimeout(() => {
            interviewSidebar.classList.add('visible');
          }, 300);
        }
      });

      // Функция отправки сообщения в чат
      function sendChatMessage() {
        const input = document.getElementById('chatInput');
        const message = input.value.trim();
        if (!message) return;

        const chatMessages = document.getElementById('chatMessages');
        const chatWelcome = document.getElementById('chatWelcome');
        if (chatWelcome) chatWelcome.remove();

        // Добавляем сообщение пользователя
        chatMessages.innerHTML += `
          <div class="interview-message">
            <div class="interview-message-answer">
              <div class="interview-message-label">✍️ Вы</div>
              <div>${escapeHtml(message)}</div>
            </div>
          </div>
        `;

        input.value = '';
        input.disabled = true;
        document.getElementById('chatSendBtn').disabled = true;

        // Добавляем индикатор загрузки
        chatMessages.innerHTML += '<div class="chat-loading" id="chatLoading">Интервьюер печатает...</div>';
        scrollChatToBottom();

        // Отправляем на сервер
        const code = window.editor ? window.editor.getValue() : '';
        const taskText = document.querySelector('.task-description')?.innerText || '';

        fetch('{% url "code_chat_api" %}', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': '{{ csrf_token }}'
          },
          body: new URLSearchParams({
            action: 'send_message',
            message: message,
            code: code,
            task_text: taskText,
            language: document.getElementById('language-selector')?.value || 'Python'
          })
        })
        .then(r => r.json())
        .then(data => {
          document.getElementById('chatLoading')?.remove();
          input.disabled = false;
          document.getElementById('chatSendBtn').disabled = false;

          if (data.success) {
            chatMessages.innerHTML += `
              <div class="interview-message">
                <div class="interview-message-question">
                  <div class="interview-message-label">👨‍💻 Интервьюер</div>
                  <div>${escapeHtml(data.message)}</div>
                </div>
              </div>
            `;
          } else {
            chatMessages.innerHTML += `
              <div class="interview-message">
                <div class="feedback-message error">Ошибка: ${escapeHtml(data.error || 'Неизвестная ошибка')}</div>
              </div>
            `;
          }
          scrollChatToBottom();
        })
        .catch(err => {
          document.getElementById('chatLoading')?.remove();
          input.disabled = false;
          document.getElementById('chatSendBtn').disabled = false;
          console.error('Chat error:', err);
        });
      }

      // Отправка по Enter
      document.addEventListener('DOMContentLoaded', function() {
        const chatInput = document.getElementById('chatInput');
        if (chatInput) {
          chatInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
              sendChatMessage();
            }
          });
        }
      });

      // Анализ кода после запуска тестов
      function analyzeCodeAfterTests(testResults) {
        const chatMessages = document.getElementById('chatMessages');
        const interviewSidebar = document.getElementById('interviewSidebar');
        
        if (!chatMessages || !interviewSidebar) return;

        // Разворачиваем чат
        interviewSidebar.classList.remove('collapsed');

        const chatWelcome = document.getElementById('chatWelcome');
        if (chatWelcome) chatWelcome.remove();

        // Добавляем индикатор загрузки
        chatMessages.innerHTML += '<div class="chat-loading" id="chatLoading">Анализирую ваш код...</div>';
        scrollChatToBottom();

        const code = window.editor ? window.editor.getValue() : '';
        const taskText = document.querySelector('.task-description')?.innerText || '';

        fetch('{% url "code_chat_api" %}', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': '{{ csrf_token }}'
          },
          body: new URLSearchParams({
            action: 'analyze_code',
            code: code,
            task_text: taskText,
            test_results: testResults,
            language: document.getElementById('language-selector')?.value || 'Python'
          })
        })
        .then(r => r.json())
        .then(data => {
          document.getElementById('chatLoading')?.remove();

          if (data.success) {
            let qualityClass = '';
            if (data.code_quality === 'good') qualityClass = '';
            else if (data.code_quality === 'needs_improvement') qualityClass = 'warning';
            else qualityClass = 'error';

            let html = `
              <div class="interview-message">
                <div class="feedback-message ${qualityClass}">
                  <div class="interview-message-label">🔍 Обратная связь</div>
                  <div>${escapeHtml(data.feedback)}</div>
            `;

            if (data.hint) {
              html += `
                  <div style="margin-top: 10px; padding: 10px; background: rgba(255, 193, 7, 0.15); border-radius: 6px; border-left: 3px solid #ffc107;">
                    <strong>💡 Подсказка:</strong> ${escapeHtml(data.hint)}
                  </div>
              `;
            }

            if (data.encouragement) {
              html += `<div style="margin-top: 8px; font-style: italic; color: #6c757d;">${escapeHtml(data.encouragement)}</div>`;
            }

            html += '</div></div>';
            chatMessages.innerHTML += html;
          } else {
            chatMessages.innerHTML += `
              <div class="interview-message">
                <div class="feedback-message error">Ошибка анализа: ${escapeHtml(data.error || 'Неизвестная ошибка')}</div>
              </div>
            `;
          }
          scrollChatToBottom();
        })
        .catch(err => {
          document.getElementById('chatLoading')?.remove();
          console.error('Analyze error:', err);
        });
      }

      function scrollChatToBottom() {
        const content = document.getElementById('chatContent');
        if (content) {
          content.scrollTop = content.scrollHeight;
        }
      }

      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      document.addEventListener('DOMContentLoaded', function() {
        const userInput = document.getElementById('user-input');
        const hiddenInput = document.getElementById('input_data');
        const codeForm = document.getElementById('code-form');
        
        if (userInput && hiddenInput) {
          // Sync on input
          userInput.addEventListener('input', function() {
            hiddenInput.value = userInput.value;
          });
          
          // Initialize value
          if (userInput.value) {
            hiddenInput.value = userInput.value;
          }
        }
        
        // Update hidden input before form submission
        if (codeForm) {
          codeForm.addEventListener('submit', function(e) {
            if (userInput && hiddenInput) {
              hiddenInput.value = userInput.value;
            }
          });
        }
        
        // Auto-switch to testcases tab if test mode
        {% if test_mode and test_results %}
          setTimeout(function() {
            switchTab('testcases');
          }, 100);

          // Автоматически анализируем код после запуска тестов
          {% if theory_completed %}
          setTimeout(function() {
            const testResultsStr = `{% for result in test_results %}Тест {{ result.number }}: {% if result.passed %}✓ Пройден{% elif result.timeout %}⏱ Таймаут{% else %}✗ Не пройден{% endif %} | Вход: {{ result.input|default:"" }} | Ожидалось: {{ result.expected|default:"" }} | Получено: {{ result.actual|default:"" }}{% if result.error %} | Ошибка: {{ result.error }}{% endif %}\n{% endfor %}Итого: {{ tests_passed }}`;
            analyzeCodeAfterTests(testResultsStr);
          }, 500);
          {% endif %}
        {% endif %}
      });
    </script>

    {% if user.is_authenticated and user.is_candidate and theory_completed %}
    <script>
      // ================= АНТИЧИТ ДЛЯ РЕДАКТОРА =================
      const isCandidateUser = true;
      const canReportSuspicious = true;

      function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
          const cookies = document.cookie.split(';');
          for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
              cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
              break;
            }
          }
        }
        return cookieValue;
      }

      async function reportSuspiciousActivity(type, details = '') {
        if (!canReportSuspicious) return;
        const csrftoken = getCookie('csrftoken') || '{{ csrf_token }}';
        const formData = new FormData();
        formData.append('action', 'report_suspicious');
        formData.append('type', type);
        formData.append('details', details);
        formData.append('timestamp', new Date().toISOString());

        try {
          await fetch('{% url "interview_api" %}', {
            method: 'POST',
            headers: { 'X-CSRFToken': csrftoken },
            body: formData
          });
        } catch (err) {
          console.warn('reportSuspiciousActivity error', err);
        }
      }

      function showAntiCheatToast(message) {
        const toast = document.createElement('div');
        toast.style.cssText = `
          position: fixed;
          bottom: 20px;
          right: 20px;
          background: linear-gradient(135deg, #ff6b6b, #ff9a76);
          color: #fff;
          padding: 14px 18px;
          border-radius: 12px;
          box-shadow: 0 8px 24px rgba(255, 107, 107, 0.4);
          font-size: 13px;
          font-weight: 500;
          z-index: 2000;
          max-width: 320px;
        `;
        toast.textContent = message;
        document.body.appendChild(toast);
        setTimeout(() => {
          toast.style.opacity = '0';
          toast.style.transition = 'opacity 0.3s';
          setTimeout(() => toast.remove(), 300);
        }, 4000);
      }

      // Tab switch detection
      document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
          reportSuspiciousActivity('tab_switch_code', 'Переключение вкладки во время решения задачи');
          showAntiCheatToast('Обнаружено переключение на другую вкладку. Это действие записано в отчёт.');
        }
      });
      window.addEventListener('blur', () => {
        reportSuspiciousActivity('window_blur_code', 'Окно потеряло фокус во время решения задачи');
        showAntiCheatToast('Окно редактора потеряло фокус. Пожалуйста, не отвлекайтесь от задания.');
      });

      // Clipboard monitoring in CodeMirror
      if (window.editor) {
        window.editor.on('beforeChange', (cm, change) => {
          if (change.origin === 'paste') {
            const pastedText = change.text.join('\n');
            const trimmed = pastedText.trim();
            if (!trimmed) {
              return;
            }
            const currentCode = cm.getValue();
            const isOwnCode = currentCode.includes(trimmed);

            const minLength = 30; // ignore very short snippets
            if (!isOwnCode && trimmed.replace(/\s+/g, '').length >= minLength) {
              reportSuspiciousActivity(
                'code_paste_external',
                `Подозрительная вставка (первые 80 символов): "${trimmed.substring(0, 80)}..."`
              );
              showAntiCheatToast('Обнаружена вставка внешнего кода. Такие действия фиксируются.');
            }
          }
        });
      } else {
        document.addEventListener('DOMContentLoaded', () => {
          if (window.editor) {
            window.editor.on('beforeChange', (cm, change) => {
              if (change.origin === 'paste') {
                const pastedText = change.text.join('\n');
                const trimmed = pastedText.trim();
                if (!trimmed) return;
                const currentCode = cm.getValue();
                const isOwnCode = currentCode.includes(trimmed);
                const minLength = 30;
                if (!isOwnCode && trimmed.replace(/\s+/g, '').length >= minLength) {
                  reportSuspiciousActivity(
                    'code_paste_external',
                    `Подозрительная вставка (первые 80 символов): "${trimmed.substring(0, 80)}..."`
                  );
                  showAntiCheatToast('Обнаружена вставка внешнего кода. Такие действия фиксируются.');
                }
              }
            });
          }
        });
      }
      // ================= КОНЕЦ АНТИЧИТ =================
    </script>
    {% endif %}

    <!-- Модальное окно бана -->
    {% include 'codeapp/ban_modal.html' %}
</body>
</html>