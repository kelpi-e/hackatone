<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Python Executor</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono&display=swap" rel="stylesheet">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/material-darker.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/hint/show-hint.min.css">

<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/python/python.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/hint/show-hint.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/hint/anyword-hint.min.js"></script>

<style>
html, body { height: 100%; margin: 0; font-family: 'JetBrains Mono', monospace; font-size: 16px; background-color: #1e1e2f; color: #c0c0c0; }
h1 { text-align: center; color: #ffcc00; margin: 10px 0; }
.main-container { display: flex; height: calc(100vh - 50px); gap: 10px; padding: 0 10px 10px 10px; overflow: hidden; }
.editor-column { display: flex; flex-direction: column; flex: 1; }
.task-section { background-color: #2b2b3c; padding: 10px; border-radius: 8px; margin-bottom: 10px; font-weight: bold; line-height: 1.5; flex: 0 0 auto; }
.code-output-container { display: flex; flex-direction: column; flex: 1; min-height: 0; }
.CodeMirror { flex: 1; border-radius: 8px; font-size: 18px; min-height: 100px; }
.output { background-color: #2b2b3c; padding: 10px; border-radius: 8px; overflow-y: auto; font-size: 18px; min-height: 100px; max-height: 70%; }
.vert-resizer { height: 5px; cursor: row-resize; background-color: #444; margin: 5px 0; }
.chat-column { flex: 1; display: flex; flex-direction: column; background-color: #2b2b3c; border-radius: 8px; padding: 10px; }
.chat-messages { flex: 1; background-color: #1e1e2f; border-radius: 5px; padding: 10px; overflow-y: auto; }
.chat-input { margin-top: 10px; display: flex; gap: 5px; }
.chat-input textarea { flex: 1; border-radius: 5px; padding: 5px; font-family: 'JetBrains Mono', monospace; font-size: 14px; resize: none; }
.chat-input button { flex: 0 0 80px; }
button { margin-top: 10px; background-color: #ff6600; color: #fff; border: none; padding: 10px 20px; font-size: 16px; cursor: pointer; border-radius: 5px; transition: 0.3s; }
button:hover { background-color: #ff8533; }
.resizer { width: 5px; cursor: col-resize; background-color: #444; }
</style>
</head>
<body>
<h1>Python Executor</h1>

<div class="main-container">
    <div class="editor-column" id="left">
        <div class="task-section">
            <form method="get" action="{% url 'runcode' %}">
                <label for="task-select"><strong>Выберите задачу:</strong></label>
                <select id="task-select" name="task" onchange="this.form.submit()">
                    {% for task_file in tasks %}
                        <option value="{{ task_file }}" {% if task_file == selected_task %}selected{% endif %}>{{ task_file }}</option>
                    {% endfor %}
                </select>
            </form>
            <pre style="white-space: pre-wrap; margin-top:10px;">{{ task_text }}</pre>
        </div>

        <div class="code-output-container">
            <form method="post" action="{% url 'run_code' %}">
                {% csrf_token %}
                <input type="hidden" name="task" value="{{ selected_task }}">

                <textarea id="code" name="code" placeholder="Введите ваш код здесь...">{{ code|default:"" }}</textarea>

                <label for="input-data"><strong>Входные данные (для обычного запуска):</strong></label>
                <textarea id="input-data" name="input_data" rows="4" placeholder="Например: 1 2 3 4">{{ input_data|default:"" }}</textarea>

                <div style="margin-top:10px;">
                    <button type="submit" name="mode" value="run_tests">Run Tests</button>
                    <button type="submit" name="mode" value="run_code">Run Code</button>
                </div>
            </form>

            {% if tests_passed %}
                <div style="margin-top:10px; color:#ffcc00;"><strong>{{ tests_passed }}</strong></div>
            {% endif %}

            <div class="vert-resizer" id="vert-resizer"></div>
            <div class="output" id="output"><pre>{{ output }}</pre></div>
        </div>
    </div>

    <div class="resizer" id="resizer"></div>

    <div class="chat-column" id="right">
        <div class="chat-messages"></div>
        <div class="chat-input">
            <textarea rows="3" placeholder="Написать сообщение..."></textarea>
            <button>Отправить</button>
        </div>
    </div>
</div>

<script>
// CodeMirror
var editor = CodeMirror.fromTextArea(document.getElementById('code'), {
    mode: "python",
    lineNumbers: true,
    indentUnit: 4,
    theme: "material-darker",
    viewportMargin: Infinity,
    extraKeys: {"Ctrl-Space": "autocomplete"}
});
editor.on("inputRead", function(cm, change) {
    if (change.text[0].match(/\w/)) CodeMirror.showHint(cm, CodeMirror.hint.anyword, {completeSingle: false});
});

// Горизонтальный ресайзер
const resizer = document.getElementById('resizer');
const left = document.getElementById('left');
const right = document.getElementById('right');
let isResizing = false;
resizer.addEventListener('mousedown', e => { isResizing = true; document.body.style.cursor='col-resize'; });
document.addEventListener('mousemove', e => {
    if (!isResizing) return;
    let pointerX = e.clientX - left.parentNode.offsetLeft;
    let minWidth = 200;
    let maxWidth = left.parentNode.clientWidth - minWidth - resizer.offsetWidth;
    if(pointerX < minWidth) pointerX = minWidth;
    if(pointerX > maxWidth) pointerX = maxWidth;
    left.style.flex = '0 0 '+pointerX+'px';
    right.style.flex='1';
});
document.addEventListener('mouseup', e => { isResizing = false; document.body.style.cursor='default'; });

// Вертикальный ресайзер для вывода
const vertResizer = document.getElementById('vert-resizer');
const codeContainer = document.querySelector('.CodeMirror');
const output = document.getElementById('output');
let isResizingV = false;
vertResizer.addEventListener('mousedown', e => { isResizingV = true; document.body.style.cursor='row-resize'; });
document.addEventListener('mousemove', e => {
    if (!isResizingV) return;
    let containerTop = codeContainer.parentNode.getBoundingClientRect().top;
    let newHeight = e.clientY - containerTop;
    if (newHeight < 100) newHeight = 100;
    if (newHeight > window.innerHeight - 200) newHeight = window.innerHeight - 200;
    codeContainer.style.height = newHeight + 'px';
});
document.addEventListener('mouseup', e => { isResizingV = false; document.body.style.cursor='default'; });
</script>
</body>
</html>
